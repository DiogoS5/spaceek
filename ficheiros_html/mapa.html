<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa de Salas - Spaceek</title>
    <link rel="stylesheet" href="../style.css">
    <!-- Adicione o CSS do Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
          crossorigin=""/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>

        header {
            z-index: 100;
            position: sticky;
            top: 0;
            left: 0;
            width: 100%;
        }

        #map-container {
            overflow: visible !important; /* allow content like popups to overflow */
            z-index: 0;
            width: 100%;
            height: 500px;
            border-radius: var(--border-radius);
            margin-top: 50px; /* Ajusta conforme a altura real do teu header */
            position: relative;
        }
        
        #map {
            width: 100%;
            height: 100%;
            border-radius: var(--border-radius);
        }
        
        .map-info {
            position: absolute;
            top: 1rem;
            left: 1rem;
            background-color: white;
            padding: 1rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            z-index: 1000;
            max-width: 300px;
        }
        
        .map-controls {
            position: absolute;
            bottom: 1rem;
            right: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            z-index: 1000;
        }
        
    .map-control-btn {
        background-color: white;
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: var(--shadow);
        cursor: pointer;
        transition: background-color 0.2s;
        font-size: 1.2rem;
    }
    .map-control-btn:hover {
        background-color: var(--color-secondary);
    }

        .map-legend {
            background-color: white;
            padding: 1rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-top: 1rem;
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
            flex: 1 1 200px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }

        .legend-low {
            background-color: var(--color-success);
        }

        .legend-medium {
            background-color: var(--color-warning);
        }

        .legend-high {
            background-color: var(--color-danger);
        }
        
        .custom-marker {
            border-radius: 50%;
            width: 20px;
            height: 20px;
            text-align: center;
            line-height: 20px;
            color: white;
            font-weight: bold;
            border: 2px solid white;
        }

        /* Estilo para o marcador destacado */
        .highlighted-marker {
            width: 40px !important;
            height: 40px !important;
            z-index: 1001 !important;
        }

        /* Animação de pulsação para o círculo ao redor do marcador selecionado */
        .pulse-circle {
            animation: mapPulse 2s infinite;
        }

        @keyframes mapPulse {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(3);
                opacity: 0.5;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Estilo para o banner de sala selecionada */
        .selected-room-banner {
            position: fixed;
            top: 70px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(59, 130, 246, 0.95);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25), 0 0 15px rgba(59, 130, 246, 0.5);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            animation: fadeInDown 0.5s ease-out, pulse-light 2s infinite;
            max-width: 90%;
            white-space: nowrap;
            
            text-overflow: ellipsis;
            border: 2px solid white;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translate(-50%, -20px);
            }
            to {
                opacity: 1;
                transform: translate(-50%, 0);
            }
        }

        @keyframes pulse-light {
            0% {
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25), 0 0 15px rgba(59, 130, 246, 0.5);
            }
            50% {
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25), 0 0 25px rgba(59, 130, 246, 0.8);
            }
            100% {
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25), 0 0 15px rgba(59, 130, 246, 0.5);
            }
        }

        .filter-chip {
            display: inline-flex;
            align-items: center;
            background-color: var(--color-secondary);
            border: 1px solid var(--color-border);
            border-radius: 9999px;
            padding: 0.5rem 1rem;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .filter-chip.active {
            background-color: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }
        
        .filter-chip i {
            margin-right: 0.5rem;
        }
        
        .filter-chips {
            margin-bottom: 1rem;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .filter-label {
            margin-right: 0.5rem;
            font-weight: 500;
            font-size: 0.875rem;
        }
        
        /* Estilo para o painel de salas próximas */
        .nearby-rooms-panel {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            width: 300px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .nearby-rooms-panel.visible {
            display: block;
        }

        .nearby-rooms-header {
            padding: 1rem;
            border-bottom: 1px solid var(--color-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nearby-rooms-list {
            padding: 0.5rem;
        }

        .nearby-room-item {
            padding: 0.75rem;
            border-radius: var(--border-radius);
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
            border: 1px solid var(--color-border);
        }

        .nearby-room-item:hover {
            background-color: var(--color-secondary);
        }

        .nearby-room-item.selected {
            border-color: var(--color-primary);
            background-color: rgba(59, 130, 246, 0.1);
        }

        .nearby-room-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .nearby-room-details {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--color-text-light);
        }

        /* Painel lateral para desktop, modal para mobile */
        .room-details-panel {
            display: none;
            position: fixed;
            top: 0;
            right: 0;
            width: 340px;
            max-width: 95vw;
            height: 100vh;
            background: #fff;
            box-shadow: -2px 0 24px rgba(80,60,180,0.10);
            z-index: 2000;
            padding: 2rem 1.5rem 1.5rem 1.5rem;
            overflow-y: auto;
            border-radius: 1.2rem 0 0 1.2rem;
            transition: transform 0.3s;
        }
        .room-details-panel.open {
            display: block;
            animation: fadeInRight 0.3s;
        }
        @keyframes fadeInRight {
            from { transform: translateX(100%);}
            to { transform: translateX(0);}
        }
        .close-details-panel {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 2rem;
            color: #6d28d9;
            cursor: pointer;
        }
        @media (max-width: 600px) {
            .room-details-panel {
                width: 100vw;
                left: 0;
                right: 0;
                top: auto;
                bottom: 0;
                height: auto;
                min-height: 40vh;
                border-radius: 1.2rem 1.2rem 0 0;
                padding: 1.2rem 1rem 1rem 1rem;
                box-shadow: 0 -2px 24px rgba(80,60,180,0.10);
            }
        }

        /* Notification styles */
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-md);
            padding: 1rem;
            max-width: 350px;
            z-index: 1000;
            transform: translateY(100px);
            opacity: 0;
            transition: transform 0.3s, opacity 0.3s;
        }
        
        .notification.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .notification-content {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .notification.success .notification-content i {
            color: var(--color-success);
        }
        
        .notification.error .notification-content i {
            color: var(--color-danger);
        }
        
        .notification-close {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: none;
            border: none;
            font-size: 1rem;
            cursor: pointer;
            color: var(--color-text-light);
        }
        
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-md);
            width: 90%;
            max-width: 500px;
            animation: slideIn 0.3s;
        }
        
        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }
        
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
        }
        
        .modal-tabs {
            display: flex;
            border-bottom: 1px solid var(--color-border);
            margin-bottom: 1.5rem;
        }
        
        .modal-tab {
            padding: 0.75rem 1.5rem;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            font-weight: 500;
            transition: border-color 0.2s, color 0.2s;
            color: var(--color-text-light);
        }
        
        .modal-tab.active {
            border-bottom-color: var(--color-primary);
            color: var(--color-primary);
        }
        
        .modal-body {
            padding: 1rem 0;
        }
        
        .modal-body h2 {
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
            text-align: center;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        
        .form-group input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            font-size: 1rem;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }
        
        .social-login {
            margin-top: 1.5rem;
            text-align: center;
            padding-top: 1.5rem;
            border-top: 1px solid var(--color-border);
        }
        
        .google-btn {
            background-color: white;
            color: #333;
            border: 1px solid #ddd;
            padding: 0.75rem 1.5rem;
        }
        
        /* Custom popup styles */
        .leaflet-popup-pane  {
            border-radius: var(--border-radius);
            padding: 0;
            z-index: 3000 !important;
    position: relative;
        }
        
        .custom-popup .leaflet-popup-content {
            margin: 0;
            width: 250px !important;
            z-index: 2000;
        }
        
        .custom-popup .leaflet-popup-content-wrapper {
    z-index: 2000;
    position: relative;
}

        .custom-popup .leaflet-popup-tip {
            background-color: white;
        }

        /* User location marker pulse animation */
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            70% { transform: scale(3); opacity: 0; }
            100% { transform: scale(1); opacity: 0; }
        }
        
        .user-location-marker::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background-color: #3b82f6;
            z-index: -1;
            animation: pulse 2s infinite;
        }
        
        #main-subtitle {
            font-weight: bold;
            color: #d765f3;         /* Light purple, adjust as needed */
            font-size: 1.3rem;      /* Bigger size */
            margin-bottom: 1.5rem;
        }

    </style>
</head>
<body>
    <header>
        <div class="container-header">
          <div class="logo-area">
            <img src="../imagens/logo.png" alt="Logo do Spaceek" class="logo">
            <span class="nome-empresa">Spaceek</span>
          </div>
          <nav class="menu" id="mainMenu">
            <a href="../index.html">Início</a>
            <a class="active">Mapa</a>
            <a href="https://group4pic.wixstudio.com/spaceseek">Sobre</a>
            <a href="#" id="loginBtn" class="login-btn">Login</a>
          </nav>
          <div class="user-profile" style="display: none;">
            <div class="user-avatar">
              <span id="userInitial">A</span>
            </div>
            <div class="user-dropdown">
              <a href="#" id="favoritesLink">Meus Favoritos</a>
              <a href="#" id="logoutBtn">Sair</a>
            </div>
          </div>
          <div class="menu-hamburger" id="menuHamburger">&#9776;</div>
        </div>
    </header>
    
    <main>
        <section class="results">
            <div class="container">
                <h2>Mapa de Salas de Estudo</h2>
                <p id="main-subtitle">Visualize a localização das salas de estudo no campus.</p>
                
                <!-- FILTER BUTTONS: Match index.html style and layout -->
                <div class="filter-tabs" id="filterTabs">
                    <div class="filter-group">
                        <button class="tab active" data-filter="all"><i class="fas fa-th"></i> Todas</button>
                        <button class="tab" data-filter="low"><i class="fas fa-check-circle"></i> Baixa</button>
                        <button class="tab" data-filter="medium"><i class="fas fa-exclamation-circle"></i> Média</button>
                        <button class="tab" data-filter="high"><i class="fas fa-times-circle"></i> Alta</button>
                        <button class="tab" id="favoritesFilterBtn" data-filter="favorites"><i class="fas fa-star"></i> Favoritos</button>
                    </div>
                </div>
                <!-- END FILTER BUTTONS -->
                
                <div id="map-container">
                    <div id="map"></div>
                    <div id="infoCard" style="display:none; position:absolute; z-index:5000; background:white; box-shadow:0 4px 24px rgba(0,0,0,0.18); border-radius:16px; padding:24px; max-width:350px; min-width:220px;">
                        <button id="closeInfoCard" style="position:absolute; top:8px; right:12px; background:none; border:none; font-size:1.3em; cursor:pointer;">&times;</button>
                        <div id="infoCardContent"></div>
                    </div>
                    <div class="map-controls">
                        <button class="map-control-btn" id="userLocationBtn" title="Minha Localização" aria-label="Minha Localização">
                            <i class="fas fa-location-arrow"></i>
                        </button>
                        <button class="map-control-btn" id="resetViewBtn" title="Resetar Mapa" aria-label="Resetar Mapa">
                            <i class="fas fa-home"></i>
                        </button>
                        <button class="map-control-btn" id="nearbyRoomsBtn" title="Lista de Salas disponíveis" aria-label="Lista de Salas disponíveis">
                            <i class="fas fa-list"></i>
                        </button>
                    </div>
                    <!-- Painel de salas próximas -->
                    <div class="nearby-rooms-panel" id="nearbyRoomsPanel">
                        <div class="nearby-rooms-header">
                            <h3>Lista de Salas disponíveis</h3>
                            <button class="close-btn" id="closeNearbyRoomsBtn">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="nearby-rooms-list" id="nearbyRoomsList">
                            <!-- Salas próximas serão adicionadas aqui dinamicamente -->
                        </div>
                    </div>
                </div>

                <div id="room-details-panel" class="room-details-panel">
                    <button id="close-details-panel" class="close-details-panel">&times;</button>
                    <div id="room-details-content"></div>
                </div>

                <div class="map-legend">
                    <div class="legend-item">
                        <div class="legend-color legend-low" style="background-color: #22c55e;"></div>
                        <span>Baixa ocupação (< 50%)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color legend-medium" style="background-color: #eab308;"></div>
                        <span>Média ocupação (50% - 75%)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color legend-high" style="background-color: #ef4444;"></div>
                        <span>Alta ocupação (> 75%)</span>
                    </div>
                </div>
            </div>
        </section>
    </main>
    
    <footer>
        <div class="container">
            <p>© 2025 Spaceek. Todos os direitos reservados.</p>
        </div>
    </footer>
    
    <!-- Modal de Login -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div class="modal-tabs">
                <button class="modal-tab active" data-tab="login">Login</button>
                <button class="modal-tab" data-tab="register">Registrar</button>
            </div>
            <div class="modal-body" id="loginTab">
                <h2>Login</h2>
                <div class="social-login">
                    <button class="button google-btn"><i class="fab fa-google"></i> Entrar com Google</button>
                </div>
            </div>
            <div class="modal-body" id="registerTab" style="display: none;">
                <h2>Criar Conta</h2>
                <form id="registerForm">
                    <div class="form-group">
                        <label for="registerName">Nome</label>
                        <input type="text" id="registerName" required>
                    </div>
                    <div class="form-group">
                        <label for="registerEmail">Email</label>
                        <input type="email" id="registerEmail" required>
                    </div>
                    <div class="form-group">
                        <label for="registerPassword">Senha</label>
                        <input type="password" id="registerPassword" required>
                    </div>
                    <div class="form-group">
                        <label for="registerConfirmPassword">Confirmar Senha</label>
                        <input type="password" id="registerConfirmPassword" required>
                    </div>
                    <button type="submit" class="button primary">Registrar</button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Adicione o JavaScript do Leaflet -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" 
            crossorigin=""></script>
    <script src="../script.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, getDoc, setDoc, updateDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBZrf6QJGbHiYzkmhm_hhBnb-hlfWAl9OM",
            authDomain: "spaceek-5869c.firebaseapp.com",
            projectId: "spaceek-5869c",
            storageBucket: "spaceek-5869c.appspot.com",
            messagingSenderId: "174315041988",
            appId: "1:174315041988:web:37ba8e2b2227ae395f8591",
            measurementId: "G-DJC1QL37JV"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();
        
        let map;
        let markers = [];
        let openPopupMarker = null; // tracks the currently open popup marker
        let currentUser = null;
        let userFavorites = [];
        let currentFilter = 'all';
        let istCoordinates = [38.73667, -9.14052];
        let selectedRoomId = null;
        let selectedRoomMarker = null;
        let pulseCircle = null;
        
        // Auth state observer
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // User is signed in
                currentUser = user;
                document.getElementById('loginBtn').style.display = 'none';
                document.querySelector('.user-profile').style.display = 'flex';
                document.getElementById('userInitial').textContent = user.displayName ? user.displayName.charAt(0).toUpperCase() : user.email.charAt(0).toUpperCase();
                
                // Load user favorites
                loadUserFavorites();
            } else {
                // User is signed out
                currentUser = null;
                document.getElementById('loginBtn').style.display = 'block';
                document.querySelector('.user-profile').style.display = 'none';
                userFavorites = [];
                
                // Disable favorites filter if active
                if (currentFilter === 'favorites') {
                    currentFilter = 'all';
                    document.querySelectorAll('.filter-chip').forEach(chip => {
                        chip.classList.remove('active');
                    });
                    document.querySelector('.filter-chip[data-filter="all"]').classList.add('active');
                }
                
                // Update markers
                updateMarkers();
            }
        });
        
        // Load user favorites
        async function loadUserFavorites() {
            if (!currentUser) return;
            
            try {
                const userDocRef = doc(db, "users", currentUser.uid);
                const userDoc = await getDoc(userDocRef);
                
                if (userDoc.exists() && userDoc.data().favorites) {
                    userFavorites = userDoc.data().favorites;
                } else {
                    // Create user document if it doesn't exist
                    await setDoc(userDocRef, { 
                        email: currentUser.email,
                        displayName: currentUser.displayName || '',
                        favorites: []
                    });
                    userFavorites = [];
                }
                
                // Update markers to show favorites
                updateMarkers();
            } catch (error) {
                console.error("Error loading favorites:", error);
            }
        }

        // Função para obter a cor baseada na ocupação
        function getOccupancyColor(occupancy) {
            if (occupancy < 50) return "#22c55e"; // Verde
            if (occupancy <= 75) return "#eab308"; // Amarelo
            return "#ef4444"; // Vermelho
        }
        
        // Função para obter a categoria de ocupação
        function getOccupancyCategory(occupancy) {
            if (occupancy < 50) return "low";
            if (occupancy <= 75) return "medium";
            return "high";
        }

        // Função para inicializar o mapa com dados do Firebase
        async function initMapWithFirebase() {
            // Coordenadas do IST
            // Rectangle bounds: [southWest, northEast]
            const bounds = [
                [38.735182, -9.143602], // Southwest (minLat, minLng)
                [38.738292609237, -9.136187229319052] // Northeast (maxLat, maxLng)
            ];

            // ...existing code...
            window.map = map = L.map('map', {
                zoomControl: true,
                attributionControl: false,
                maxZoom: 22,
                minZoom: 17,
                maxBounds: bounds,
                maxBoundsViscosity: 1.0,
            }).fitBounds(bounds);

            const minDesiredZoom = 16; // or 16 for even more area
            if (map.getZoom() > minDesiredZoom) {
                map.setZoom(minDesiredZoom);
            }
            setTimeout(() => map.invalidateSize(), 300);

            // --- Enable map interaction only while pressing/touching ---
            map.dragging.disable();
            map.scrollWheelZoom.disable();
            map.doubleClickZoom.disable();
            map.boxZoom.disable();
            map.keyboard.disable();
            if (map.tap) map.tap.disable();

            const mapContainer = map.getContainer();

            function enableMapInteraction() {
                map.dragging.enable();
                map.scrollWheelZoom.enable();
                map.doubleClickZoom.enable();
                map.boxZoom.enable();
                map.keyboard.enable();
                if (map.tap) map.tap.enable();
            }

            function disableMapInteraction() {
                map.dragging.disable();
                map.scrollWheelZoom.disable();
                map.doubleClickZoom.disable();
                map.boxZoom.disable();
                map.keyboard.disable();
                if (map.tap) map.tap.disable();
            }

            // Mouse events
            mapContainer.addEventListener('mousedown', enableMapInteraction);
            mapContainer.addEventListener('mouseup', disableMapInteraction);
            mapContainer.addEventListener('mouseleave', disableMapInteraction);

            // Touch events (for mobile)
            mapContainer.addEventListener('touchstart', enableMapInteraction);
            mapContainer.addEventListener('touchend', disableMapInteraction);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 22
            }).addTo(map);
            // Ensure default zoom control is enabled (top left)
            map.zoomControl.setPosition('topleft');

            // Busca dados do Firebase
            let roomsData = [];
            try {
                const querySnapshot = await getDocs(collection(db, "salas"));
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    // Add document ID to the data
                    data.id = doc.id;
                    roomsData.push(data);
                });
            } catch (error) {
                alert("Erro ao buscar salas do Firebase para o mapa.");
                return;
            }
            
            // Check URL parameters for specific room
            const urlParams = new URLSearchParams(window.location.search);
            const salaName = urlParams.get('sala');
            const roomId = urlParams.get('id');
            
            if (salaName && roomId) {
                // Find the room in the data
                const room = roomsData.find(r => r.id === roomId);
                if (room && room.location && typeof room.location.latitude === 'number' && typeof room.location.longitude === 'number') {
                    // Center map on this room
                    map.setView([room.location.latitude, room.location.longitude], 19);
                    
                    // Set as selected room
                    selectedRoomId = roomId;
                    // Show info box/banner for this room
                }
            }
            
            // Store rooms data and create markers
            window.roomsData = roomsData;
            createMarkers(roomsData);
            
            // Add map control events
            document.getElementById('resetViewBtn').addEventListener('click', function() {
                map.setView(istCoordinates, 17);
            });
            
            // Update user location button logic to match split view
            let userLocationMarker = null;
            let userAccuracyCircle = null;
            document.getElementById('userLocationBtn').addEventListener('click', function() {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(function(position) {
                        const userLocation = [position.coords.latitude, position.coords.longitude];
                        map.setView(userLocation, 18);
                        // Remove previous marker/circle if any
                        if (userLocationMarker) map.removeLayer(userLocationMarker);
                        if (userAccuracyCircle) map.removeLayer(userAccuracyCircle);
                        // Add user marker (white with blue border, always on top)
                        userLocationMarker = L.circleMarker(userLocation, {
                            radius: 10,
                            color: '#2563eb', // blue border
                            weight: 4,
                            fillColor: '#fff',
                            fillOpacity: 1,
                            pane: 'markerPane'
                        }).addTo(map);
                        // Add accuracy circle
                        userAccuracyCircle = L.circle(userLocation, {
                            radius: position.coords.accuracy,
                            color: '#3b82f6',
                            fillColor: '#3b82f6',
                            fillOpacity: 0.1,
                            interactive: false
                        }).addTo(map);
                        // Remove after 30 seconds
                        setTimeout(() => {
                            if (userLocationMarker) map.removeLayer(userLocationMarker);
                            if (userAccuracyCircle) map.removeLayer(userAccuracyCircle);
                        }, 30000);
                    }, function(error) {
                        alert("Erro ao obter sua localização: " + error.message);
                    });
                } else {
                    alert("Geolocalização não é suportada pelo seu navegador.");
                }
            });
            
            // Nearby rooms panel
            document.getElementById('nearbyRoomsBtn').addEventListener('click', function() {
                const panel = document.getElementById('nearbyRoomsPanel');
                panel.classList.toggle('visible');
                
                if (panel.classList.contains('visible')) {
                    updateNearbyRoomsList();
                }
            });
            
            document.getElementById('closeNearbyRoomsBtn').addEventListener('click', function() {
                document.getElementById('nearbyRoomsPanel').classList.remove('visible');
            });
            
            // Map click event to clear selection
            map.on('click', function(e) {
                // Check if click was on a marker
                let clickedOnMarker = false;
                markers.forEach(marker => {
                    if (marker instanceof L.Marker && marker.getLatLng().distanceTo(e.latlng) < 20) {
                        clickedOnMarker = true;
                    }
                });
                
                // If not clicked on a marker, clear selection
                if (!clickedOnMarker) {
                    clearSelectedRoom();
                }
            });

            setTimeout(() => {
                map.invalidateSize();
            }, 300);

            
        }
        
        // Create markers for rooms
        function createMarkers(roomsData) {
            // Clear existing markers
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            
            // Remove existing pulse circle if any
            if (pulseCircle) {
                map.removeLayer(pulseCircle);
                pulseCircle = null;
            }
            
            roomsData.forEach(room => {
                if (room.location && typeof room.location.latitude === 'number' && typeof room.location.longitude === 'number') {
                    const ocupacao = (room.curOcc && room.maxOcc) ? Math.round((room.curOcc / room.maxOcc) * 100) : 0;
                    const occupancyCategory = getOccupancyCategory(ocupacao);
                    const isFavorite = userFavorites.includes(room.id);
                    const isSelected = room.id === selectedRoomId;
                    
                    // Skip if filtering by favorites and not a favorite
                    if (currentFilter === 'favorites' && !isFavorite) return;
                    
                    // Skip if filtering by occupancy category
                    if (['low', 'medium', 'high'].includes(currentFilter) && currentFilter !== occupancyCategory) return;
                    
                    // Restore original marker: just a colored circle, no border highlight, no icon overlay
                    const markerIcon = L.divIcon({
                        className: 'custom-marker',
                        html: `<div style="
                            background-color: ${getOccupancyColor(ocupacao)};
                            width: 100%;
                            height: 100%;
                            border-radius: 50%;
                            border: 2px solid white;
                        "></div>`,
                        iconSize: isSelected ? [32, 32] : [20, 20],
                        iconAnchor: isSelected ? [16, 16] : [10, 10] // anchor at bottom center for popup above
                    });
                    
                    const marker = L.marker([room.location.latitude, room.location.longitude], { icon: markerIcon, title: room.name || 'Sala' }).addTo(map);
                    
                    // Store reference to selected room marker
                    if (isSelected) {
                        selectedRoomMarker = marker;
                        // Não adiciona círculo pulsante!
                    }
                    
                    // Determine noise level and color
                    let ruidoLabel = 'Desconhecido';
                    let ruidoColor = '#d1d5db'; // cinza
                    if (typeof room.noise_lvl === 'number') {
                        if (room.noise_lvl < 50) {
                            ruidoLabel = 'Baixo';
                            ruidoColor = '#22c55e'; // verde
                            if(room.noise_lvl < 30) 
                                ruidoLabel = 'Muito Baixo';
                        } else if (room.noise_lvl < 70) {
                            ruidoLabel = 'Médio';
                            ruidoColor = '#eab308'; // amarelo
                        } else {
                            ruidoLabel = 'Alto';
                            ruidoColor = '#ef4444'; // vermelho
                        }
                    }
                    
                    // Create popup content
                    const popupContent = `
                        <div class="split-card" style="background: #fff; border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.10); padding: 1.2rem 1.2rem 1rem 1.2rem; min-width: 260px; max-width: 340px; font-family: inherit; position: relative;">
        <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 0.5rem; margin-bottom: 0.5rem;">
            <div>
                <h3 style="margin: 0; font-size: 1.25rem; font-weight: 600; color: #6d28d9;">${room.name || 'Sala'}</h3>
                <div style="font-size: 0.97em; color: #64748b; margin-top: 2px; margin-bottom: 0.7em;">${room.Location || ''}</div>
            </div>
            <button class="favorite-btn${isFavorite ? ' active' : ''}" data-room-id="${room.id}" style="background: none; border: none; cursor: pointer; font-size: 1.4em; color: ${isFavorite ? '#f59e0b' : '#d1d5db'}; z-index: 10; padding: 0; margin: 0; align-self: flex-start;">
                <i class="${isFavorite ? 'fas' : 'far'} fa-star"></i>
            </button>
        </div>
        <div style="height: 8px;"></div>
        <div style="display: flex; flex-direction: column; gap: 0.5em; margin-bottom: 0.7em; width: 100%;">
            <div style="display: flex; align-items: center; width: 100%; gap: 0.2em;">
                <span style="font-size: 1em; font-weight: bold; color: #334155; min-width: 60px; text-align: left;">Ocupação</span>
                <div style="flex: 1 1 0; display: flex; align-items: center; justify-content: center; margin: 0 0.2em;">
                    <div style="height: 10px; background-color: #e5e7eb; border-radius: 9999px; overflow: hidden; width: 100%; max-width: 120px; min-width: 60px;">
                        <div style="height: 100%; width: ${ocupacao}%; background-color: ${getOccupancyColor(ocupacao)};"></div>
                    </div>
                </div>
                <span style="font-size: 0.97em; color: #222; min-width: 36px; text-align: right; margin-left: 0.15em;">${ocupacao}%</span>
            </div>
            ${room.temperature !== undefined ? `
            <div style="display: flex; align-items: center; width: 100%; gap: 0.7em;">
                <span style="font-size: 1em; font-weight: bold; color: #334155; min-width: 0px; text-align: center;">Temperatura</span>
                <span style="flex: 1;"></span>
                <span style="font-size: 0.93em; background-color: ${getTemperatureColor(room.temperature)}; color: white; padding: 2px 2px; border-radius: 5px; display: flex; align-items: center; gap: 0.3em; min-width: 44px; max-width: 54px; justify-content: flex-end; text-align: right; font-weight: normal;">
                    <i class="fas fa-thermometer-half"></i> ${room.temperature}°C
                </span>
            </div>` : ''}
            <div style="display: flex; align-items: center; width: 100%; gap: 0.7em;">
                <span style="font-size: 1em; font-weight: bold; color: #334155; min-width: 90px; text-align: left;">Ruído</span>
                <span style="flex: 1;"></span>
                <span style="font-size: 0.93em; background-color: ${ruidoColor}; color: white; padding: 2px 6px; border-radius: 6px; display: flex; align-items: center; gap: 0.3em; min-width: 60px; justify-content: flex-end; text-align: right; font-weight: normal;">
                    <i class="fas ${getRuidoIcon(room.noise_lvl)}"></i> ${ruidoLabel}
                </span>
            </div>
        </div>
        <div style="display: flex; flex-direction: column; align-items: center; width: 100%; gap: 0.5em;">
            <button class="button primary" style="text-align: center; margin-top: 0.7em; padding: 10px 0; border-radius: 8px; background: linear-gradient(90deg, #6366f1 0%, #3b82f6 100%); color: #fff; text-decoration: none; font-size: 1.07em; font-weight: 600; box-shadow: 0 2px 8px rgba(59,130,246,0.10); width: 88%; max-width: 240px; border: none; transition: background 0.2s, box-shadow 0.2s; display: flex; align-items: center; justify-content: center; gap: 0.5em;" id="verDetalhesBtn">
                <i class="fas fa-info-circle"></i> Ver Detalhes
            </button>
        </div>
    </div>
`; 

                    const popup = L.popup({
    closeButton: false, // Remove the cross from the popup
    className: 'custom-popup',
    autoPan: true, // Ensure the map pans to keep the popup visible
    pane: 'popupPane' // Use the popup pane for proper z-index
}).setContent(popupContent);

                
                    
                    // Add click event to select room
   marker.on('click', function(e) {
    // If this marker is already selected, hide the info card
    if (selectedRoomId === room.id) {
        document.getElementById('infoCard').style.display = 'none';
        selectedRoomId = null;
        return;
    }

    // Get the pixel position of the marker relative to the map container
    const map = window.map;
    const latlng = marker.getLatLng();
    const point = map.latLngToContainerPoint(latlng);

    // Position the info card near the marker (above and centered)
    const infoCard = document.getElementById('infoCard');
    infoCard.style.left = (point.x) + 'px';
    infoCard.style.top = (point.y - 10) + 'px'; // 10px above the marker
    infoCard.style.transform = 'translate(-50%, -100%)'; // center horizontally, above marker

    // Show info card with this room's content
    selectedRoomId = room.id;
    document.getElementById('infoCardContent').innerHTML = popupContent;
    infoCard.style.display = 'block';
});
// Close button handler (only add this once, outside the marker loop)
document.getElementById('closeInfoCard').onclick = function() {
    document.getElementById('infoCard').style.display = 'none';
    selectedRoomId = null;
};

                    // Add favorite button event
                    marker.on('popupopen', function() {
                        setTimeout(() => {
                            const favoriteBtn = document.querySelector('.favorite-btn[data-room-id="' + room.id + '"]');
                            if (favoriteBtn) {
                                favoriteBtn.addEventListener('click', function(e) {
                                    e.stopPropagation();
                                    const roomId = this.getAttribute('data-room-id');
                                    toggleFavorite(roomId);
                                });
                            }
                            // Add Ver Detalhes button logic to redirect to index.html splitview for this room
                            const verDetalhesBtn = document.getElementById('verDetalhesBtn');
                            if (verDetalhesBtn) {
                                verDetalhesBtn.onclick = function(e) {
                                    e.stopPropagation();
                                    window.location.href = '/index.html?splitview=1&id=' + room.id;
                                };
                            }
                        }, 0);
                    });
                    
                    markers.push(marker);
                }
            });
            
            // Update nearby rooms list if panel is visible
            if (document.getElementById('nearbyRoomsPanel').classList.contains('visible')) {
                updateNearbyRoomsList();
            }
        }
        
        // When a marker is selected, make it grow and match the splitview style
        function highlightMarker(roomId) {
            selectedRoomId = roomId;
            createMarkers(window.roomsData);
            // Do NOT showRoomDetails or showSelectedRoomBanner here
        }

        // Close room details panel
        document.getElementById('close-details-panel').onclick = function() {
            document.getElementById('room-details-panel').classList.remove('open');
        };
        
        // Select a room
        function selectRoom(room) {
            // Clear previous selection
            clearSelectedRoom();
            
            // Set new selection
            selectedRoomId = room.id;
            
            // Update markers to highlight selected room
            createMarkers(window.roomsData);
            
            // Update nearby rooms list
            updateNearbyRoomsList();
        }
        
        // Clear selected room
        function clearSelectedRoom() {
            selectedRoomId = null;
            
            // Update markers
            createMarkers(window.roomsData);
            
            // Update nearby rooms list
            updateNearbyRoomsList();
        }
        
        // Update nearby rooms list
        function updateNearbyRoomsList() {
            const nearbyRoomsList = document.getElementById('nearbyRoomsList');
            nearbyRoomsList.innerHTML = '';
            
            if (!window.roomsData) return;
            
            // Get current map center
            const mapCenter = map.getCenter();
            
            // Filter rooms by current filter
            let filteredRooms = window.roomsData.filter(room => {
                if (!room.location || typeof room.location.latitude !== 'number' || typeof room.location.longitude !== 'number') {
                    return false;
                }
                
                const ocupacao = (room.curOcc && room.maxOcc) ? Math.round((room.curOcc / room.maxOcc) * 100) : 0;
                const occupancyCategory = getOccupancyCategory(ocupacao);
                const isFavorite = userFavorites.includes(room.id);
                
                // Apply filters
                if (currentFilter === 'favorites' && !isFavorite) return false;
                if (['low', 'medium', 'high'].includes(currentFilter) && currentFilter !== occupancyCategory) return false;
                
                return true;
            });
            
            // Sort by distance to map center
            filteredRooms.forEach(room => {
                const roomLatLng = L.latLng(room.location.latitude, room.location.longitude);
                room.distance = mapCenter.distanceTo(roomLatLng);
            });
            
            filteredRooms.sort((a, b) => a.distance - b.distance);
            
            // Take top 10
            filteredRooms = filteredRooms.slice(0, 10);
            
            // Render rooms
            filteredRooms.forEach(room => {
                const ocupacao = (room.curOcc && room.maxOcc) ? Math.round((room.curOcc / room.maxOcc) * 100) : 0;
                const isSelected = room.id === selectedRoomId;
                
                const roomItem = document.createElement('div');
                roomItem.className = `nearby-room-item ${isSelected ? 'selected' : ''}`;
                roomItem.innerHTML = `
                    <div class="nearby-room-name">${room.name || 'Sala'}</div>
                    <div class="nearby-room-details">
                        <span>${room.building || ''}</span>
                        <span style="color: ${getOccupancyColor(ocupacao)};">${ocupacao}% ocupação</span>
                    </div>
                `;
                
                roomItem.addEventListener('click', function() {
                    // Select room and fly to it
                    selectRoom(room);
                    map.flyTo([room.location.latitude, room.location.longitude], 18);
                });
                
                nearbyRoomsList.appendChild(roomItem);
            });
            
            // Show message if no rooms
            if (filteredRooms.length === 0) {
                nearbyRoomsList.innerHTML = `
                    <div style="padding: 1rem; text-align: center; color: var(--color-text-light);">
                        Nenhuma sala encontrada com os filtros atuais.
                    </div>
                `;
            }
        }
        
        // Toggle favorite
        async function toggleFavorite(roomId) {
            if (!currentUser) {
                // Show login modal if user is not logged in
                document.getElementById('loginModal').style.display = 'block';
                return;
            }
            
            try {
                const userDocRef = doc(db, "users", currentUser.uid);
                
                if (userFavorites.includes(roomId)) {
                    // Remove from favorites
                    await updateDoc(userDocRef, {
                        favorites: arrayRemove(roomId)
                    });
                    userFavorites = userFavorites.filter(id => id !== roomId);
                } else {
                    // Add to favorites
                    await updateDoc(userDocRef, {
                        favorites: arrayUnion(roomId)
                    });
                    userFavorites.push(roomId);
                }
                
                // Update markers
                updateMarkers();
                
                // Update favorite button in popup
                const favoriteBtn = document.querySelector(`.favorite-btn[data-room-id="${roomId}"]`);
                if (favoriteBtn) {
                    const isFavorite = userFavorites.includes(roomId);
                    favoriteBtn.classList.toggle('active', isFavorite);
                    favoriteBtn.style.color = isFavorite ? '#f59e0b' : '#d1d5db';
                    favoriteBtn.innerHTML = `<i class="${isFavorite ? 'fas' : 'far'} fa-star"></i>`;
                }
            } catch (error) {
                console.error("Error updating favorites:", error);
            }
        }
        
        // Update markers based on current filter
        function updateMarkers() {
            if (window.roomsData) {
                createMarkers(window.roomsData);
            }
        }
        
        // --- FILTER BUTTONS LOGIC: Match index.html behavior ---
        document.querySelectorAll('.filter-tabs .tab').forEach(tab => {
            tab.addEventListener('click', function() {
                // If Favoritos and not logged in, show login modal
                if (this.getAttribute('data-filter') === 'favorites' && !currentUser) {
                    document.getElementById('loginModal').style.display = 'block';
                    return;
                }
                // Remove active from all tabs
                document.querySelectorAll('.filter-tabs .tab').forEach(t => t.classList.remove('active'));
                // Add active to clicked tab
                this.classList.add('active');
                // Update currentFilter
                currentFilter = this.getAttribute('data-filter');
                // Update markers
                updateMarkers();
                // Recenter map to default view
                if (typeof map !== 'undefined' && map) {
                    map.setView(istCoordinates, 17);
                }
            });
        });
        
        // Remove JS that toggles .active on .map-control-btn (no growing/highlight)
        
        // Helper functions
        function getTemperatureColor(temp) {
            if (temp < 18) return '#3b82f6'; // cold
            if (temp < 22) return '#60a5fa'; // cool
            if (temp < 25) return '#22c55e'; // comfortable
            if (temp < 28) return '#f59e0b'; // warm
            return '#ef4444'; // hot
        }
        
        function getRuidoIcon(ruido) {
            if (ruido >= 70) return 'fa-volume-up';
            if (ruido >= 50) return 'fa-volume-down';
            return 'fa-volume-off';
        }
        
        // --- LOGIN MODAL GOOGLE-ONLY (Consistent with index.html, no email/password, no register) ---
        (function() {
            // Remove modal tabs and email/password/register forms
            const loginModal = document.getElementById('loginModal');
            if (loginModal) {
                // Remove modal-tabs if present
                const modalTabs = loginModal.querySelector('.modal-tabs');
                if (modalTabs) modalTabs.remove();
                // Remove registerTab if present
                const registerTab = loginModal.querySelector('#registerTab');
                if (registerTab) registerTab.remove();
                // Replace loginTab content with Google-only
                const loginTab = loginModal.querySelector('#loginTab');
                if (loginTab) {
                    loginTab.innerHTML = `
                        <h2>Entrar</h2>
                        <div class="social-login">
                            <button class="button google-btn"><i class="fab fa-google"></i> Entrar com Google</button>
                        </div>
                    `;
                }
            }
            // Modal open/close logic
            const loginBtn = document.getElementById('loginBtn');
            const closeBtn = loginModal ? loginModal.querySelector('.close') : null;
            if (loginBtn) {
                loginBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    loginModal.classList.add('open');
                });
            }
            if (closeBtn) {
                closeBtn.addEventListener('click', function() {
                    loginModal.classList.remove('open');
                });
            }
            window.addEventListener('click', function(event) {
                if (event.target === loginModal) {
                    loginModal.classList.remove('open');
                }
            });
            // Google login button logic
            setTimeout(() => {
                const googleBtn = document.querySelector('.google-btn');
                if (googleBtn) {
                    googleBtn.addEventListener('click', async function(e) {
                        e.preventDefault();
                        try {
                            const result = await signInWithPopup(auth, provider);
                            const user = result.user;
                            // Create user in Firestore if not exists
                            const userDocRef = doc(db, "users", user.uid);
                            const userDoc = await getDoc(userDocRef);
                            if (!userDoc.exists()) {
                                await setDoc(userDocRef, {
                                    email: user.email,
                                    displayName: user.displayName || '',
                                    favorites: []
                                });
                            }
                            localStorage.setItem('spaceek-login', Date.now());
                            loginModal.classList.remove('open');
                        } catch (error) {
                            alert('Erro ao fazer login com Google.');
                        }
                    });
                }
            }, 0);
            // Logout logic (sync across tabs)
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', async function() {
                    try {
                        await signOut(auth);
                        localStorage.setItem('spaceek-logout', Date.now());
                    } catch (error) {
                        alert('Erro ao fazer logout.');
                    }
                });
            }
            // Sync login/logout state across tabs/pages
            window.addEventListener('storage', function(event) {
                if (event.key === 'spaceek-logout') {
                    signOut(auth).then(() => {
                        window.location.reload();
                    });
                } else if (event.key === 'spaceek-login') {
                    window.location.reload();
                }
            });
            // User profile dropdown logic (show/hide)
            const userProfile = document.querySelector('.user-profile');
            if (userProfile) {
                userProfile.addEventListener('mouseenter', function() {
                    userProfile.classList.add('open');
                });
                userProfile.addEventListener('mouseleave', function() {
                    userProfile.classList.remove('open');
                });
            }
        })();
        document.addEventListener('DOMContentLoaded', function() {
            initMapWithFirebase();
        });
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
    const hamburger = document.getElementById('menuHamburger');
    const menu = document.getElementById('mainMenu');
    if (hamburger && menu) {
        hamburger.addEventListener('click', function() {
            menu.classList.toggle('active');
            setTimeout(() => {
                if (window.map) window.map.invalidateSize();
            }, 350); // Wait for menu animation if any
        });
    }
});
    </script>
</body>
</html>