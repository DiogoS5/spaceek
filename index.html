<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Salas de Estudo - Universidade</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <div class="container-header">
          <div class="logo-area">
            <img src="imagens/logo.png" alt="Logo do Spaceek" class="logo">
            <span class="nome-empresa">Spaceek</span>
          </div>
          <nav class="menu">
            <a class="active">Início</a>
            <a href="ficheiros_html/mapa.html">Mapa</a>
            <a href="https://group4pic.wixstudio.com/spaceseek">Sobre</a>
          </nav>
          <div class="menu-hamburger" onclick="toggleMenu()">&#9776;</div>
        </div>
    </header>
      
    <main>
        <section class="hero">
            <div class="container">
                <h2>Encontre o melhor local para estudar</h2>
                <p>Pesquise salas de estudo disponíveis, verifique condições em tempo real e reserve seu espaço.</p>
                
                <div class="search-container">
                    <div class="search-box">
                        <input type="search" id="search-input" placeholder="Pesquisar salas de estudo...">
                        <button type="submit" class="search-button" id="search-button">Buscar</button>
                    </div>
                    <a href="ficheiros_html/mapa.html" class="map-button">Ver no Mapa</a>
                </div>
            </div>
        </section>

        <section class="results">
            <div class="container">
                <h2>Salas Disponíveis</h2>
                <p>Encontre a sala ideal para suas necessidades de estudo.</p>
                <div class="filter-tabs" id="filterTabs">
                    <div class="filter-group">
                        <button class="tab active" data-filter="all">Todos</button>
                        <button class="tab" data-filter="library">Bibliotecas</button>
                        <button class="tab" data-filter="study">Salas de Estudo</button>
                    </div>
                    <button class="tab ocupacao-btn" id="ocupacaoBtn">
                        Ocupação <img id="ocupacaoArrow" src="imagens/upwardarrow.png" alt="Seta Ocupação" style="width:1em;height:1em;vertical-align:middle;transition:transform 0.2s;">
                    </button>
                </div>
                <div id="firebase-names"></div>
                
                <div class="study-rooms" id="study-rooms"></div>
            </div>
        </section>
    </main>

    <footer>
        <div class="container">
            <p>© 2024 Spaceek. Todos os direitos reservados.</p>
            <nav>
                <a href="#">Termos de Serviço</a>
                <a href="#">Privacidade</a>
            </nav>
        </div>
    </footer>

    <script src="script.js"></script>
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBZrf6QJGbHiYzkmhm_hhBnb-hlfWAl9OM",
            authDomain: "spaceek-5869c.firebaseapp.com",
            projectId: "spaceek-5869c",
            storageBucket: "spaceek-5869c.appspot.com",
            messagingSenderId: "174315041988",
            appId: "1:174315041988:web:37ba8e2b2227ae395f8591",
            measurementId: "G-DJC1QL37JV"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let allRooms = [];
        let ocupacaoOrder = 'menor';

        async function getNames() 
        {
            try {
                const querySnapshot = await getDocs(collection(db, "salas"));
                allRooms = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    allRooms.push(data);
                });
                renderRooms('all');
            } catch (error) {
                console.error("Error fetching study rooms:", error);
                const studyRooms = document.getElementById('study-rooms');
                studyRooms.innerHTML = "<span style='color:red'>Erro ao buscar salas do Firebase.</span>";
            }
        }

        const ocupacaoBtn = document.getElementById('ocupacaoBtn');
        const ocupacaoArrow = document.getElementById('ocupacaoArrow');
        ocupacaoBtn.addEventListener('click', function() {
            ocupacaoOrder = ocupacaoOrder === 'menor' ? 'maior' : 'menor';
            if (ocupacaoOrder === 'menor') {
                ocupacaoArrow.style.transform = 'rotate(0deg)';
                ocupacaoArrow.alt = 'Seta para cima';
            } else {
                ocupacaoArrow.style.transform = 'rotate(180deg)';
                ocupacaoArrow.alt = 'Seta para baixo';
            }
            renderRooms(getCurrentFilter());
        });

        function getCurrentFilter() {
            const activeTab = document.querySelector('.filter-group .tab.active');
            return activeTab ? activeTab.getAttribute('data-filter') : 'all';
        }

        function setOcupacaoBtnActive() {
            document.querySelectorAll('.tab.ocupacao-btn').forEach(btn => btn.classList.remove('active'));
            ocupacaoBtn.classList.add('active');
        }

        function renderRooms(filterType) {
            const studyRooms = document.getElementById('study-rooms');
            studyRooms.innerHTML = '';
            let filteredRooms = allRooms;
            if (filterType === 'library') {
                filteredRooms = allRooms.filter(room => room.type === 'library');
            } else if (filterType === 'study') {
                filteredRooms = allRooms.filter(room => room.type === 'study');
            }
            // Sort by ocupacao
            filteredRooms = filteredRooms.slice(); // clone array
            filteredRooms.sort((a, b) => {
                const aOcc = (a.curOcc && a.maxOcc) ? a.curOcc / a.maxOcc : 0;
                const bOcc = (b.curOcc && b.maxOcc) ? b.curOcc / b.maxOcc : 0;
                if (ocupacaoOrder === 'maior') {
                    return bOcc - aOcc;
                } else {
                    return aOcc - bOcc;
                }
            });
            filteredRooms.forEach((data) => {
                const name = data.name || 'Sala';
                const bloco = data.building || '';
                const curOcc = data.curOcc || 0;
                const maxOcc = data.maxOcc || 0;
                const ocupacao = (data.curOcc !== 0 && data.maxOcc !== 0)
                    ? Math.round((curOcc / maxOcc) * 100)
                    : null;
                let ocupacaoColor = '#22c55e';
                if (ocupacao >= 75) ocupacaoColor = '#ef4444';
                else if (ocupacao >= 50) ocupacaoColor = '#eab308';
                const temperatura = data.temperature !== undefined ? data.temperature : null;
                const ruido = data.noise_lvl !== undefined ? data.noise_lvl : null;
                let ruidoClass = '';
                let ruidoLabel = '';
                if (ruido >= 70) { ruidoClass = 'high'; ruidoLabel = 'Alto'; }
                else if (ruido >= 50) { ruidoClass = 'medium'; ruidoLabel = 'Médio'; }
                else if (ruido >= 30) { ruidoClass = 'low'; ruidoLabel = 'Baixo'; }
                else if (ruido < 30) { ruidoClass = 'very-low'; ruidoLabel = 'Muito Baixo'; }
                const card = document.createElement('div');
                card.className = 'room-card';
                card.innerHTML = `
                    <div class="room-header">
                        <h3>${name}</h3>
                        <p>${bloco}</p>
                    </div>
                    <div class="room-indicators">
                        ${ocupacao !== null ? `
                        <div class="indicator">
                            <span class="indicator-label">Ocupação:</span>
                            <div class="progress-container">
                                <div class="progress-bar" style="width: ${ocupacao}%; background-color: ${ocupacaoColor};"></div>
                            </div>
                            <span class="indicator-value">${ocupacao}%</span>
                        </div>` : ''}
                        ${temperatura !== null ? `
                        <div class="indicator">
                            <span class="indicator-label">Temperatura:</span>
                            <span class="badge">${temperatura}°C</span>
                        </div>` : ''}
                        ${ruido !== null ? `
                        <div class="indicator">
                            <span class="indicator-label">Nível de Ruído:</span>
                            <span class="badge noise ${ruidoClass}">${ruidoLabel}</span>
                        </div>` : ''}
                    </div>
                    <div class="room-actions">
                        <button class="button secondary">Detalhes</button>
                        <button class="button primary">Reservar</button>
                    </div>
                `;
                studyRooms.appendChild(card);
            });
        }

        // Tab click event
        document.querySelectorAll('.filter-group .tab').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.filter-group .tab').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                renderRooms(getCurrentFilter());
            });
        });

        getNames();
    </script>
</body>
</html>