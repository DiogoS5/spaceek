<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Salas de Estudo - Universidade</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
</head>
<body>
    <header>
        <div class="container-header">
          <div class="logo-area">
            <img src="imagens/logo.png" alt="Logo do Spaceek" class="logo">
            <span class="nome-empresa">Spaceek</span>
          </div>
          <nav class="menu">
            <a class="active">Início</a>
            <a href="ficheiros_html/mapa.html">Mapa</a>
            <a href="https://group4pic.wixstudio.com/spaceseek">Sobre</a>
          </nav>
          <div class="menu-hamburger" onclick="toggleMenu()">&#9776;</div>
        </div>
    </header>
      
    <main>
        <section class="results">
            <div class="container" id="main-container">
                <div class="results-header-flex">
                    <h2>Salas Disponíveis</h2>
                </div>
                <p>Encontre a sala ideal para suas necessidades de estudo.</p>
                <div class="filter-tabs" id="filterTabs">
                    <div class="filter-group">
                        <button class="tab active" data-filter="all">Todos</button>
                        <button class="tab" data-filter="library">Bibliotecas</button>
                        <button class="tab" data-filter="study">Salas de Estudo</button>
                        <div class="tab search-tab" tabindex="0">
                            <form style="display:flex;align-items:center;gap:0;" onsubmit="return false;">
                                <button type="button" class="search-icon-btn" id="search-icon-btn" aria-label="Pesquisa" title="Pesquisa" tabindex="-1" style="background:none;border:none;padding:0;margin:0;cursor:pointer;display:flex;align-items:center;justify-content:center;height:2.5rem;width:2.5rem;">
                                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="9" cy="9" r="7" stroke="#000" stroke-width="2"/><path d="M15 15L18 18" stroke="#000" stroke-width="2" stroke-linecap="round"/></svg>
                                </button>
                                <input type="search" id="search-input" placeholder="Pesquisar salas de estudo..." style="border:none;background:transparent;width:0;transition:width 0.3s,opacity 0.3s;padding:0;opacity:0;outline:none;font-size:0.95em;" autocomplete="off">
                            </form>
                        </div>
                    </div>
                    <button class="tab ocupacao-btn" id="ocupacaoBtn">
                        Ocupação <img id="ocupacaoArrow" src="imagens/upwardarrow.png" alt="Seta Ocupação" style="width:1em;height:1em;vertical-align:middle;transition:transform 0.2s;">
                    </button>
                </div>
                <div id="firebase-names"></div>
                <div class="study-rooms" id="study-rooms"></div>
                <div id="split-view" style="display:none;"></div>
            </div>
        </section>
    </main>

    <footer>
        <div class="container">
            <p>© 2024 Spaceek. Todos os direitos reservados.</p>
            <nav>
                <a href="#">Termos de Serviço</a>
                <a href="#">Privacidade</a>
            </nav>
        </div>
    </footer>

    <script src="script.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBZrf6QJGbHiYzkmhm_hhBnb-hlfWAl9OM",
            authDomain: "spaceek-5869c.firebaseapp.com",
            projectId: "spaceek-5869c",
            storageBucket: "spaceek-5869c.appspot.com",
            messagingSenderId: "174315041988",
            appId: "1:174315041988:web:37ba8e2b2227ae395f8591",
            measurementId: "G-DJC1QL37JV"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let allRooms = [];
        let ocupacaoOrder = 'menor';

        async function getNames() 
        {
            try {
                const querySnapshot = await getDocs(collection(db, "salas"));
                allRooms = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    allRooms.push(data);
                });
                renderRooms('all');
            } catch (error) {
                console.error("Error fetching study rooms:", error);
                const studyRooms = document.getElementById('study-rooms');
                studyRooms.innerHTML = "<span style='color:red'>Erro ao buscar salas do Firebase.</span>";
            }
        }

        const ocupacaoBtn = document.getElementById('ocupacaoBtn');
        const ocupacaoArrow = document.getElementById('ocupacaoArrow');
        ocupacaoBtn.addEventListener('click', function() {
            ocupacaoOrder = ocupacaoOrder === 'menor' ? 'maior' : 'menor';
            if (ocupacaoOrder === 'menor') {
                ocupacaoArrow.style.transform = 'rotate(0deg)';
                ocupacaoArrow.alt = 'Seta para cima';
            } else {
                ocupacaoArrow.style.transform = 'rotate(180deg)';
                ocupacaoArrow.alt = 'Seta para baixo';
            }
            renderRooms(getCurrentFilter());
        });

        function getCurrentFilter() {
            const activeTab = document.querySelector('.filter-group .tab.active');
            return activeTab ? activeTab.getAttribute('data-filter') : 'all';
        }

        function setOcupacaoBtnActive() {
            document.querySelectorAll('.tab.ocupacao-btn').forEach(btn => btn.classList.remove('active'));
            ocupacaoBtn.classList.add('active');
        }

        function renderRooms(filterType) {
            const studyRooms = document.getElementById('study-rooms');
            studyRooms.innerHTML = '';
            let filteredRooms = allRooms;
            if (filterType === 'library') {
                filteredRooms = allRooms.filter(room => room.type === 'library');
            } else if (filterType === 'study') {
                filteredRooms = allRooms.filter(room => room.type === 'study');
            }
            // Sort by ocupacao
            filteredRooms = filteredRooms.slice(); // clone array
            filteredRooms.sort((a, b) => {
                const aOcc = (a.curOcc && a.maxOcc) ? a.curOcc / a.maxOcc : 0;
                const bOcc = (b.curOcc && b.maxOcc) ? b.curOcc / b.maxOcc : 0;
                if (ocupacaoOrder === 'maior') {
                    return bOcc - aOcc;
                } else {
                    return aOcc - bOcc;
                }
            });
            filteredRooms.forEach((data, idx) => {
                const name = data.name || 'Sala';
                const bloco = data.building || '';
                const curOcc = data.curOcc || 0;
                const maxOcc = data.maxOcc || 0;
                const ocupacao = (data.curOcc !== 0 && data.maxOcc !== 0)
                    ? Math.round((curOcc / maxOcc) * 100)
                    : null;
                let ocupacaoColor = '#22c55e';
                if (ocupacao >= 75) ocupacaoColor = '#ef4444';
                else if (ocupacao >= 50) ocupacaoColor = '#eab308';
                const temperatura = data.temperature !== undefined ? data.temperature : null;
                const ruido = data.noise_lvl !== undefined ? data.noise_lvl : null;
                let ruidoClass = '';
                let ruidoLabel = '';
                if (ruido >= 70) { ruidoClass = 'high'; ruidoLabel = 'Alto'; }
                else if (ruido >= 50) { ruidoClass = 'medium'; ruidoLabel = 'Médio'; }
                else if (ruido >= 30) { ruidoClass = 'low'; ruidoLabel = 'Baixo'; }
                else if (ruido < 30) { ruidoClass = 'very-low'; ruidoLabel = 'Muito Baixo'; }
                const card = document.createElement('div');
                card.className = 'room-card';
                card.innerHTML = `
                    <div class="room-header">
                        <h3 class="room-name" style="color:var(--color-primary)">${name}</h3>
                        <p>${bloco}</p>
                    </div>
                    <div class="room-indicators">
                        ${ocupacao !== null ? `
                        <div class="indicator">
                            <span class="indicator-label">Ocupação:</span>
                            <div class="progress-container">
                                <div class="progress-bar" style="width: ${ocupacao}%; background-color: ${ocupacaoColor};"></div>
                            </div>
                            <span class="indicator-value">${ocupacao}%</span>
                        </div>` : ''}
                        ${temperatura !== null ? `
                        <div class="indicator">
                            <span class="indicator-label">Temperatura:</span>
                            <span class="badge">${temperatura}°C</span>
                        </div>` : ''}
                        ${ruido !== null ? `
                        <div class="indicator">
                            <span class="indicator-label">Nível de Ruído:</span>
                            <span class="badge noise ${ruidoClass}">${ruidoLabel}</span>
                        </div>` : ''}
                    </div>
                    <div class="room-actions">
                        <button class="button secondary detalhes-btn">Detalhes</button>
                        <button class="button primary">Reservar</button>
                    </div>
                `;
                // Add click event to Detalhes button for split view
                card.querySelector('.detalhes-btn').addEventListener('click', function(e) {
                    showSplitView(data);
                });
                studyRooms.appendChild(card);
            });
        }

        // Split view logic
        function showSplitView(roomData) {
            document.querySelector('.results .study-rooms').style.display = 'none';
            document.getElementById('filterTabs').style.display = 'none';
            const splitView = document.getElementById('split-view');
            splitView.style.display = 'flex';
            splitView.innerHTML = `
                <div class="split-card">
                    <button class="button secondary voltar-btn" style="margin-bottom:1rem;">Voltar</button>
                    <div class="room-card">
                        <div class="room-header">
                            <h3>${roomData.name || 'Sala'}</h3>
                            <p>${roomData.building || ''}</p>
                        </div>
                        <div class="room-indicators">
                            ${(roomData.curOcc && roomData.maxOcc) ? `<div class="indicator">
                                <span class="indicator-label">Ocupação:</span>
                                <div class="progress-container">
                                    <div class="progress-bar" style="width: ${Math.round((roomData.curOcc/roomData.maxOcc)*100)}%; background-color: ${getOcupacaoColor(Math.round((roomData.curOcc/roomData.maxOcc)*100))};"></div>
                                </div>
                                <span class="indicator-value">${Math.round((roomData.curOcc/roomData.maxOcc)*100)}%</span>
                            </div>` : ''}
                            ${roomData.temperature !== undefined ? `<div class="indicator">
                                <span class="indicator-label">Temperatura:</span>
                                <span class="badge">${roomData.temperature}°C</span>
                            </div>` : ''}
                            ${roomData.noise_lvl !== undefined ? `<div class="indicator">
                                <span class="indicator-label">Nível de Ruído:</span>
                                <span class="badge noise ${getRuidoClass(roomData.noise_lvl)}">${getRuidoLabel(roomData.noise_lvl)}</span>
                            </div>` : ''}
                        </div>
                    </div>
                </div>
                <div class="split-map-container">
                    <div id="split-map"></div>
                </div>
            `;
            // Add back button event
            splitView.querySelector('.voltar-btn').addEventListener('click', function() {
                splitView.style.display = 'none';
                document.querySelector('.results .study-rooms').style.display = '';
                document.getElementById('filterTabs').style.display = '';
            });
            // Render map for this room
            setTimeout(() => renderSplitMap(roomData), 0);
        }

        function getOcupacaoColor(ocupacao) {
            if (ocupacao >= 75) return '#ef4444';
            if (ocupacao >= 50) return '#eab308';
            return '#22c55e';
        }
        function getRuidoClass(ruido) {
            if (ruido >= 70) return 'high';
            if (ruido >= 50) return 'medium';
            if (ruido >= 30) return 'low';
            return 'very-low';
        }
        function getRuidoLabel(ruido) {
            if (ruido >= 70) return 'Alto';
            if (ruido >= 50) return 'Médio';
            if (ruido >= 30) return 'Baixo';
            return 'Muito Baixo';
        }
        function renderSplitMap(roomData) {
            const mapDiv = document.getElementById('split-map');
            mapDiv.innerHTML = '';
            mapDiv.style.width = '100%';
            mapDiv.style.height = '400px';
            if (roomData.location && typeof roomData.location.latitude === 'number' && typeof roomData.location.longitude === 'number') {
                const lat = roomData.location.latitude;
                const lng = roomData.location.longitude;
                const map = L.map('split-map').setView([lat, lng], 18);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);
                const markerIcon = L.divIcon({
                    className: 'custom-marker',
                    html: `<div style="background-color: ${getOcupacaoColor(Math.round((roomData.curOcc/roomData.maxOcc)*100))}; width: 100%; height: 100%; border-radius:50%"></div>`,
                    iconSize: [24, 24]
                });
                const marker = L.marker([lat, lng], { icon: markerIcon, title: roomData.name || 'Sala' }).addTo(map);
                marker.bindPopup(`<b>${roomData.name || 'Sala'}</b><br>${roomData.building || ''}`).openPopup();
            } else {
                mapDiv.innerHTML = '<div style="padding:2rem;text-align:center;">Localização não disponível para esta sala.</div>';
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            const searchTab = document.querySelector('.search-tab');
            const searchInput = document.getElementById('search-input');
            const searchLabel = searchTab.querySelector('.search-label');
            const searchIconBtn = document.getElementById('search-icon-btn');
            function expandSearch() {
                searchInput.style.width = '180px';
                searchInput.style.opacity = '1';
                searchInput.style.padding = '0.5em 0.7em';
                searchInput.focus();
            }
            function collapseSearch() {
                if (!searchInput.value) {
                    searchInput.style.width = '0';
                    searchInput.style.opacity = '0';
                    searchInput.style.padding = '0';
                }
            }
            searchTab.addEventListener('mouseenter', expandSearch);
            searchTab.addEventListener('mouseleave', collapseSearch);
            searchIconBtn.addEventListener('focus', expandSearch);
            searchInput.addEventListener('focus', expandSearch);
            searchInput.addEventListener('blur', collapseSearch);
            searchTab.addEventListener('focusin', expandSearch);
            searchTab.addEventListener('focusout', collapseSearch);
            searchIconBtn.addEventListener('click', expandSearch);
        });

        getNames();
    </script>
    <style>
    /* Split view styles */
    #split-view {
        display: flex;
        gap: 2rem;
        margin-top: 2rem;
        min-height: 420px;
    }
    .split-card {
        flex: 1 1 0;
        max-width: 350px;
        min-width: 0;
        display: flex;
        flex-direction: column;
        align-items: flex-start;
    }
    .split-map-container {
        flex: 2 1 0;
        min-width: 0;
        display: flex;
        align-items: stretch;
    }
    #split-map {
        width: 100%;
        height: 400px;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        background: #e5e7eb;
    }
    @media (max-width: 900px) {
        #split-view {
            flex-direction: column;
            gap: 1rem;
        }
        .split-card, .split-map-container {
            max-width: 100%;
            width: 100%;
        }
        #split-map {
            height: 300px;
        }
    }
    /* Hero section styles */
    .hero-flex {
        display: flex;
        align-items: flex-end;
        justify-content: space-between;
        gap: 2rem;
        flex-wrap: wrap;
    }
    .hero-title-search {
        flex: 1 1 300px;
        min-width: 250px;
    }
    .search-container {
        flex: 0 0 350px;
        max-width: 350px;
        min-width: 220px;
        margin-bottom: 0;
    }
    @media (max-width: 900px) {
        .hero-flex {
            flex-direction: column;
            align-items: stretch;
            gap: 1.5rem;
        }
        .search-container {
            max-width: 100%;
            width: 100%;
        }
    }
    /* Results section styles */
    .results-header-flex {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 2rem;
        flex-wrap: wrap;
        margin-bottom: 1.5rem;
    }
    .filter-tabs {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 2rem;
        padding-bottom: 0.5rem;
        position: relative;
        flex-wrap: wrap;
    }
    .filter-group {
        display: flex;
        gap: 0.5rem;
    }
    .filter-search {
        width: 44px;
        height: 44px;
        background: #fff;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        overflow: hidden;
        transition: width 0.3s cubic-bezier(.4,0,.2,1), box-shadow 0.2s;
        display: flex;
        align-items: center;
        border: 1px solid var(--color-border);
        cursor: pointer;
        position: relative;
        margin-left: 0.5rem;
        margin-right: 0.5rem;
    }
    .filter-search input {
        width: 0;
        border: none;
        outline: none;
        font-size: 1rem;
        padding: 0;
        background: transparent;
        transition: width 0.3s cubic-bezier(.4,0,.2,1), padding 0.3s;
        opacity: 0;
    }
    .filter-search button {
        background: none;
        border: none;
        color: var(--color-primary);
        font-size: 1.3rem;
        width: 44px;
        height: 44px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
        transition: background 0.2s;
    }
    .filter-search:hover,
    .filter-search:focus-within {
        width: 220px;
        box-shadow: var(--shadow-md);
    }
    .filter-search:hover input,
    .filter-search:focus-within input {
        width: 140px;
        padding: 0 0.75rem;
        opacity: 1;
        background: transparent;
    }
    .filter-search:hover button,
    .filter-search:focus-within button {
        background: var(--color-secondary);
        border-radius: 0 var(--border-radius) var(--border-radius) 0;
    }
    @media (max-width: 600px) {
        .filter-tabs {
            flex-direction: column;
            align-items: stretch;
            gap: 1rem;
        }
        .filter-search {
            width: 38px;
            height: 38px;
        }
        .filter-search:hover,
        .filter-search:focus-within {
            width: 100%;
        }
        .filter-search:hover input,
        .filter-search:focus-within input {
            width: 100%;
        }
    }
    .tab.search-tab {
        padding: 0;
        background-color: var(--color-secondary);
        border: 1px solid var(--color-border);
        border-radius: var(--border-radius);
        height: 2.5rem;
        min-width: 44px;
        display: flex;
        align-items: center;
        transition: box-shadow 0.2s;
        position: relative;
        overflow: hidden;
    }
    .tab.search-tab:focus-within,
    .tab.search-tab:hover {
        box-shadow: var(--shadow-md);
    }
    .tab.search-tab input[type="search"] {
        width: 0;
        opacity: 0;
        background: transparent;
        border: none;
        transition: width 0.3s, opacity 0.3s, padding 0.3s;
        font-size: 0.95em;
        color: var(--color-text);
    }
    .tab.search-tab:focus-within input[type="search"],
    .tab.search-tab:hover input[type="search"] {
        width: 140px;
        opacity: 1;
        padding: 0 0.75em;
        background: transparent;
    }
    .tab.search-tab button.search-button {
        background: none;
        border: none;
        color: #000;
        width: 2.2em;
        height: 2.2em;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 0 var(--border-radius) var(--border-radius) 0;
        transition: background 0.2s;
        padding: 0 0.2em;
    }
    .tab.search-tab:focus-within button.search-button,
    .tab.search-tab:hover button.search-button {
        background: var(--color-secondary);
    }
    .tab.search-tab:focus-within .search-label,
    .tab.search-tab:hover .search-label {
        display: inline-block;
    }
    @media (max-width: 600px) {
        .tab.search-tab input[type="search"] {
            width: 0;
        }
        .tab.search-tab:focus-within input[type="search"],
        .tab.search-tab:hover input[type="search"] {
            width: 100px;
        }
    }
    .search-icon-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 2.5rem;
        width: 2.5rem;
        padding: 0;
        margin: 0;
        background: none;
        border: none;
        cursor: pointer;
    }
    </style>
</body>
</html>