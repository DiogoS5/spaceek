<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spaceek - Salas de Estudo</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <header>
        <div class="container-header">
          <div class="logo-area">
            <img src="imagens/logo.png" alt="Logo do Spaceek" class="logo">
            <span class="nome-empresa">Spaceek</span>
          </div>
          <nav class="menu">
            <a class="active">Início</a>
            <a href="ficheiros_html/mapa.html">Mapa</a>
            <a href="https://group4pic.wixstudio.com/spaceseek">Sobre</a>
            <a href="#" id="loginBtn" class="login-btn">Login</a>
          </nav>
          <div class="user-profile" style="display: none;">
            <div class="user-avatar">
              <span id="userInitial">A</span>
            </div>
            <div class="user-dropdown">
              <a href="#" id="favoritesLink">Meus Favoritos</a>
              <a href="#" id="logoutBtn">Sair</a>
            </div>
          </div>
          <div class="menu-hamburger" onclick="toggleMenu()">&#9776;</div>
        </div>
    </header>
      
    <main>
        <section class="results">
            <div class="container" id="main-container">
                <div class="results-header-flex">
                    <h2>Salas Disponíveis</h2>
                </div>
                <p>Encontre a sala ideal para suas necessidades de estudo.</p>
                <div id="banner"></div>
                <div class="filter-tabs" id="filterTabs">
                    <div class="filter-group">
                        <button class="tab" data-filter="library">Bibliotecas</button>
                        <button class="tab" data-filter="study">Salas de Estudo</button>
                        <div class="tab search-tab" tabindex="0">
                            <form style="display:flex;align-items:center;gap:0;" onsubmit="return false;">
                                <button type="button" class="search-icon-btn" id="search-icon-btn" aria-label="Pesquisa" title="Pesquisa" tabindex="-1">
                                    <i class="fas fa-search"></i>
                                </button>
                                <input type="search" id="search-input" placeholder="Pesquisar salas de estudo..." autocomplete="off">
                            </form>
                        </div>
                    </div>
                    <div class="filter-options">
                        <button class="tab ocupacao-btn" id="ocupacaoBtn">
                            Ocupação <i class="fas fa-sort-amount-down" id="ocupacaoIcon"></i>
                        </button>
                        <button class="tab" id="favoritesFilterBtn">
                            <i class="far fa-star"></i> Favoritos
                        </button>
                    </div>
                </div>
                <div id="firebase-names"></div>
                <div class="study-rooms" id="study-rooms"></div>
                <div id="split-view" style="display:none;"></div>
            </div>
        </section>
    </main>

    <footer>
        <div class="container">
            <p>© 2024 Spaceek. Todos os direitos reservados.</p>
            <nav>
                <a href="#">Termos de Serviço</a>
                <a href="#">Privacidade</a>
            </nav>
        </div>
    </footer>

    <!-- Modal de Login -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div class="modal-tabs">
                <button class="modal-tab active" data-tab="login">Login</button>
                <button class="modal-tab" data-tab="register">Registrar</button>
            </div>
            <div class="modal-body" id="loginTab">
                <h2>Login</h2>
                <form id="loginForm">
                    <div class="form-group">
                        <label for="loginEmail">Email</label>
                        <input type="email" id="loginEmail" required>
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">Senha</label>
                        <input type="password" id="loginPassword" required>
                    </div>
                    <button type="submit" class="button primary">Entrar</button>
                </form>
                <div class="social-login">
                    <button class="button google-btn"><i class="fab fa-google"></i> Entrar com Google</button>
                </div>
            </div>
            <div class="modal-body" id="registerTab" style="display: none;">
                <h2>Criar Conta</h2>
                <form id="registerForm">
                    <div class="form-group">
                        <label for="registerName">Nome</label>
                        <input type="text" id="registerName" required>
                    </div>
                    <div class="form-group">
                        <label for="registerEmail">Email</label>
                        <input type="email" id="registerEmail" required>
                    </div>
                    <div class="form-group">
                        <label for="registerPassword">Senha</label>
                        <input type="password" id="registerPassword" required>
                    </div>
                    <div class="form-group">
                        <label for="registerConfirmPassword">Confirmar Senha</label>
                        <input type="password" id="registerConfirmPassword" required>
                    </div>
                    <button type="submit" class="button primary">Registrar</button>
                </form>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, setDoc, getDoc, updateDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBZrf6QJGbHiYzkmhm_hhBnb-hlfWAl9OM",
            authDomain: "spaceek-5869c.firebaseapp.com",
            projectId: "spaceek-5869c",
            storageBucket: "spaceek-5869c.appspot.com",
            messagingSenderId: "174315041988",
            appId: "1:174315041988:web:37ba8e2b2227ae395f8591",
            measurementId: "G-DJC1QL37JV"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        let allRooms = [];
        let ocupacaoOrder = 'menor';
        let currentUser = null;
        let userFavorites = [];
        let showOnlyFavorites = false;

        // Auth state observer
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // User is signed in
                currentUser = user;
                document.getElementById('loginBtn').style.display = 'none';
                document.querySelector('.user-profile').style.display = 'flex';
                document.getElementById('userInitial').textContent = user.displayName ? user.displayName.charAt(0).toUpperCase() : user.email.charAt(0).toUpperCase();
                
                // Load user favorites
                loadUserFavorites();
            } else {
                // User is signed out
                currentUser = null;
                document.getElementById('loginBtn').style.display = 'block';
                document.querySelector('.user-profile').style.display = 'none';
                userFavorites = [];
                showOnlyFavorites = false;
                document.getElementById('favoritesFilterBtn').classList.remove('active');
                renderRooms(getCurrentFilter());
            }
        });

        // Load user favorites
        async function loadUserFavorites() {
            if (!currentUser) return;
            
            try {
                const userDocRef = doc(db, "users", currentUser.uid);
                const userDoc = await getDoc(userDocRef);
                
                if (userDoc.exists() && userDoc.data().favorites) {
                    userFavorites = userDoc.data().favorites;
                } else {
                    // Create user document if it doesn't exist
                    await setDoc(userDocRef, { 
                        email: currentUser.email,
                        displayName: currentUser.displayName || '',
                        favorites: []
                    });
                    userFavorites = [];
                }
                
                // Re-render rooms to show favorites
                renderRooms(getCurrentFilter());
            } catch (error) {
                console.error("Error loading favorites:", error);
            }
        }

        // Toggle favorite
        async function toggleFavorite(roomId) {
            if (!currentUser) {
                // Show login modal if user is not logged in
                document.getElementById('loginModal').style.display = 'block';
                return;
            }
            
            try {
                const userDocRef = doc(db, "users", currentUser.uid);
                
                if (userFavorites.includes(roomId)) {
                    // Remove from favorites
                    await updateDoc(userDocRef, {
                        favorites: arrayRemove(roomId)
                    });
                    userFavorites = userFavorites.filter(id => id !== roomId);
                } else {
                    // Add to favorites
                    await updateDoc(userDocRef, {
                        favorites: arrayUnion(roomId)
                    });
                    userFavorites.push(roomId);
                }
                
                // Re-render rooms to update favorite icons
                renderRooms(getCurrentFilter());
            } catch (error) {
                console.error("Error updating favorites:", error);
            }
        }

        async function getNames() 
        {
            try {
                const querySnapshot = await getDocs(collection(db, "salas"));
                allRooms = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    // Add document ID to the data
                    data.id = doc.id;
                    allRooms.push(data);
                });
                renderRooms('all');
            } catch (error) {
                console.error("Error fetching study rooms:", error);
                const studyRooms = document.getElementById('study-rooms');
                studyRooms.innerHTML = "<span style='color:red'>Erro ao buscar salas do Firebase.</span>";
            }
        }

        const ocupacaoBtn = document.getElementById('ocupacaoBtn');
        const ocupacaoIcon = document.getElementById('ocupacaoIcon');
        ocupacaoBtn.addEventListener('click', function() {
            ocupacaoOrder = ocupacaoOrder === 'menor' ? 'maior' : 'menor';
            if (ocupacaoOrder === 'menor') {
                ocupacaoIcon.className = 'fas fa-sort-amount-down';
            } else {
                ocupacaoIcon.className = 'fas fa-sort-amount-up';
            }
            renderRooms(getCurrentFilter());
        });

        // Favorites filter button
        document.getElementById('favoritesFilterBtn').addEventListener('click', function() {
            if (!currentUser) {
                // Show login modal if user is not logged in
                document.getElementById('loginModal').style.display = 'block';
                return;
            }
            
            this.classList.toggle('active');
            showOnlyFavorites = this.classList.contains('active');
            renderRooms(getCurrentFilter());
        });

        function getCurrentFilter() {
            const activeTab = document.querySelector('.filter-group .tab.active:not(.search-tab)');
            return activeTab ? activeTab.getAttribute('data-filter') : 'all';
        }

        function renderRooms(filterType) {
            const studyRooms = document.getElementById('study-rooms');
            studyRooms.innerHTML = '';
            
            // Apply filters
            let filteredRooms = allRooms;
            if (filterType === 'library') {
                filteredRooms = allRooms.filter(room => room.type === 'library');
            } else if (filterType === 'study') {
                filteredRooms = allRooms.filter(room => room.type === 'study');
            }
            
            // Filter by favorites if needed
            if (showOnlyFavorites) {
                filteredRooms = filteredRooms.filter(room => userFavorites.includes(room.id));
            }
            
            // Sort by ocupacao
            filteredRooms = filteredRooms.slice(); // clone array
            filteredRooms.sort((a, b) => {
                const aOcc = (a.curOcc && a.maxOcc) ? a.curOcc / a.maxOcc : 0;
                const bOcc = (b.curOcc && b.maxOcc) ? b.curOcc / b.maxOcc : 0;
                if (ocupacaoOrder === 'maior') {
                    return bOcc - aOcc;
                } else {
                    return aOcc - bOcc;
                }
            });
            
            // Check if no rooms match the filters
            if (filteredRooms.length === 0) {
                studyRooms.innerHTML = `
                    <div class="no-results">
                        <i class="fas fa-search"></i>
                        <p>Nenhuma sala encontrada com os filtros selecionados.</p>
                    </div>
                `;
                return;
            }
            
            filteredRooms.forEach((data, idx) => {
                const name = data.name || 'Sala';
                const bloco = data.building || '';
                const curOcc = data.curOcc || 0;
                const maxOcc = data.maxOcc || 0;
                const ocupacao = (data.curOcc !== 0 && data.maxOcc !== 0)
                    ? Math.round((curOcc / maxOcc) * 100)
                    : null;
                let ocupacaoColor = '#22c55e';
                if (ocupacao >= 75) ocupacaoColor = '#ef4444';
                else if (ocupacao >= 50) ocupacaoColor = '#eab308';
                const temperatura = data.temperature !== undefined ? data.temperature : null;
                const ruido = data.noise_lvl !== undefined ? data.noise_lvl : null;
                let ruidoClass = '';
                let ruidoLabel = '';
                if (ruido >= 70) { ruidoClass = 'high'; ruidoLabel = 'Alto'; }
                else if (ruido >= 50) { ruidoClass = 'medium'; ruidoLabel = 'Médio'; }
                else if (ruido >= 30) { ruidoClass = 'low'; ruidoLabel = 'Baixo'; }
                else if (ruido < 30) { ruidoClass = 'very-low'; ruidoLabel = 'Muito Baixo'; }
                
                // Check if room is in favorites
                const isFavorite = userFavorites.includes(data.id);
                
                const card = document.createElement('div');
                card.className = 'room-card';
                card.innerHTML = `
                    <div class="room-header">
                        <div class="room-title">
                            <h3 class="room-name" style="color:var(--color-primary)">${name}</h3>
                            <button class="favorite-btn ${isFavorite ? 'active' : ''}" data-room-id="${data.id}">
                                <i class="${isFavorite ? 'fas' : 'far'} fa-star"></i>
                            </button>
                        </div>
                        <p>${bloco}</p>
                    </div>
                    <div class="room-indicators">
                        ${ocupacao !== null ? `
                        <div class="indicator">
                            <span class="indicator-label">Ocupação:</span>
                            <div class="progress-container">
                                <div class="progress-bar" style="width: ${ocupacao}%; background-color: ${ocupacaoColor};"></div>
                            </div>
                            <span class="indicator-value">${ocupacao}%</span>
                        </div>` : ''}
                        ${temperatura !== null ? `
                        <div class="indicator">
                            <span class="indicator-label">Temperatura:</span>
                            <span class="badge temperature-badge" style="background-color: ${getTemperatureColor(temperatura)}">
                                <i class="fas fa-thermometer-half"></i> ${temperatura}°C
                            </span>
                        </div>` : ''}
                        ${ruido !== null ? `
                        <div class="indicator">
                            <span class="indicator-label">Nível de Ruído:</span>
                            <span class="badge noise ${ruidoClass}">
                                <i class="fas ${getRuidoIcon(ruido)}"></i> ${ruidoLabel}
                            </span>
                        </div>` : ''}
                    </div>
                    <div class="room-actions">
                        <button class="button secondary detalhes-btn">
                            <i class="fas fa-info-circle"></i> Detalhes
                        </button>
                        <a href="ficheiros_html/mapa.html?sala=${encodeURIComponent(name)}&id=${data.id}" class="button primary">
                            <i class="fas fa-map-marker-alt"></i> Ver no Mapa
                        </a>
                    </div>
                `;
                
                // Add click event to Detalhes button for split view
                card.querySelector('.detalhes-btn').addEventListener('click', function(e) {
                    showSplitView(data);
                });
                
                // Add click event to favorite button
                card.querySelector('.favorite-btn').addEventListener('click', function(e) {
                    e.stopPropagation();
                    const roomId = this.getAttribute('data-room-id');
                    toggleFavorite(roomId);
                });
                
                studyRooms.appendChild(card);
            });
        }

        // Helper functions
        function getTemperatureColor(temp) {
            if (temp < 18) return '#3b82f6'; // cold
            if (temp < 22) return '#60a5fa'; // cool
            if (temp < 25) return '#22c55e'; // comfortable
            if (temp < 28) return '#f59e0b'; // warm
            return '#ef4444'; // hot
        }
        
        function getRuidoIcon(ruido) {
            if (ruido >= 70) return 'fa-volume-up';
            if (ruido >= 50) return 'fa-volume-down';
            return 'fa-volume-off';
        }

        // Split view logic
        function showSplitView(roomData) {
            document.querySelector('.results .study-rooms').style.display = 'none';
            document.getElementById('filterTabs').style.display = 'none';
            const splitView = document.getElementById('split-view');
            splitView.style.display = 'flex';
            
            // Check if room is in favorites
            const isFavorite = userFavorites.includes(roomData.id);
            
            splitView.innerHTML = `
                <div class="split-card">
                    <button class="button secondary voltar-btn" style="margin-bottom:1rem;">
                        <i class="fas fa-arrow-left"></i> Voltar
                    </button>
                    <div class="room-card">
                        <div class="room-header">
                            <div class="room-title">
                                <h3 class="room-name" style="color:var(--color-primary)">${roomData.name || 'Sala'}</h3>
                                <button class="favorite-btn ${isFavorite ? 'active' : ''}" data-room-id="${roomData.id}">
                                    <i class="${isFavorite ? 'fas' : 'far'} fa-star"></i>
                                </button>
                            </div>
                            <p>${roomData.building || ''}</p>
                        </div>
                        <div class="room-indicators">
                            ${(roomData.curOcc && roomData.maxOcc) ? `<div class="indicator">
                                <span class="indicator-label">Ocupação:</span>
                                <div class="progress-container">
                                    <div class="progress-bar" style="width: ${Math.round((roomData.curOcc/roomData.maxOcc)*100)}%; background-color: ${getOcupacaoColor(Math.round((roomData.curOcc/roomData.maxOcc)*100))};"></div>
                                </div>
                                <span class="indicator-value">${Math.round((roomData.curOcc/roomData.maxOcc)*100)}%</span>
                            </div>` : ''}
                            ${roomData.temperature !== undefined ? `<div class="indicator">
                                <span class="indicator-label">Temperatura:</span>
                                <span class="badge temperature-badge" style="background-color: ${getTemperatureColor(roomData.temperature)}">
                                    <i class="fas fa-thermometer-half"></i> ${roomData.temperature}°C
                                </span>
                            </div>` : ''}
                            ${roomData.noise_lvl !== undefined ? `<div class="indicator">
                                <span class="indicator-label">Nível de Ruído:</span>
                                <span class="badge noise ${getRuidoClass(roomData.noise_lvl)}">
                                    <i class="fas ${getRuidoIcon(roomData.noise_lvl)}"></i> ${getRuidoLabel(roomData.noise_lvl)}
                                </span>
                            </div>` : ''}
                        </div>
                        <div class="room-details">
                            <h4>Detalhes da Sala</h4>
                            <ul>
                                <li><i class="fas fa-users"></i> Capacidade: ${roomData.maxOcc || 'N/A'} pessoas</li>
                                <li><i class="fas fa-plug"></i> Tomadas: ${roomData.outlets ? 'Disponíveis' : 'Não disponíveis'}</li>
                                <li><i class="fas fa-wifi"></i> Wi-Fi: ${roomData.wifi ? 'Disponível' : 'Não disponível'}</li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="split-map-container">
                    <div id="split-map"></div>
                </div>
            `;
            
            // Add back button event
            splitView.querySelector('.voltar-btn').addEventListener('click', function() {
                splitView.style.display = 'none';
                document.querySelector('.results .study-rooms').style.display = '';
                document.getElementById('filterTabs').style.display = '';
            });
            
            // Add favorite button event
            splitView.querySelector('.favorite-btn').addEventListener('click', function() {
                const roomId = this.getAttribute('data-room-id');
                toggleFavorite(roomId);
                this.classList.toggle('active');
                const icon = this.querySelector('i');
                if (this.classList.contains('active')) {
                    icon.className = 'fas fa-star';
                } else {
                    icon.className = 'far fa-star';
                }
            });
            
            // Render map for this room
            setTimeout(() => renderSplitMap(roomData), 0);
        }

        function getOcupacaoColor(ocupacao) {
            if (ocupacao >= 75) return '#ef4444';
            if (ocupacao >= 50) return '#eab308';
            return '#22c55e';
        }
        
        function getRuidoClass(ruido) {
            if (ruido >= 70) return 'high';
            if (ruido >= 50) return 'medium';
            if (ruido >= 30) return 'low';
            return 'very-low';
        }
        
        function getRuidoLabel(ruido) {
            if (ruido >= 70) return 'Alto';
            if (ruido >= 50) return 'Médio';
            if (ruido >= 30) return 'Baixo';
            return 'Muito Baixo';
        }
        
        function renderSplitMap(roomData) {
            const mapDiv = document.getElementById('split-map');
            mapDiv.innerHTML = '';
            mapDiv.style.width = '100%';
            mapDiv.style.height = '400px';
            if (roomData.location && typeof roomData.location.latitude === 'number' && typeof roomData.location.longitude === 'number') {
                const lat = roomData.location.latitude;
                const lng = roomData.location.longitude;
                const map = L.map('split-map').setView([lat, lng], 18);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);
                const markerIcon = L.divIcon({
                    className: 'custom-marker',
                    html: `<div style="background-color: ${getOcupacaoColor(Math.round((roomData.curOcc/roomData.maxOcc)*100))}; width: 100%; height: 100%; border-radius:50%"></div>`,
                    iconSize: [24, 24]
                });
                const marker = L.marker([lat, lng], { icon: markerIcon, title: roomData.name || 'Sala' }).addTo(map);
                marker.bindPopup(`<b>${roomData.name || 'Sala'}</b><br>${roomData.building || ''}`).openPopup();
                
                const pulseCircle = L.circle([lat, lng], {
                    color: 'blue',
                    fillColor: '#blue',
                    fillOpacity: 0.5,
                    radius: 200
                }).addTo(map);
            } else {
                mapDiv.innerHTML = '<div style="padding:2rem;text-align:center;"><i class="fas fa-map-marked-alt fa-3x" style="color:#ccc;margin-bottom:1rem;"></i><p>Localização não disponível para esta sala.</p></div>';
            }
        }

        // Search functionality
        document.addEventListener('DOMContentLoaded', function() {
            const searchTab = document.querySelector('.search-tab');
            const searchInput = document.getElementById('search-input');
            const searchIconBtn = document.getElementById('search-icon-btn');
            
            function expandSearch() {
                searchTab.classList.add('expanded');
                searchInput.focus();
            }
            
            function collapseSearch() {
                if (!searchInput.value) {
                    searchTab.classList.remove('expanded');
                }
            }
            
            searchTab.addEventListener('mouseenter', expandSearch);
            searchTab.addEventListener('mouseleave', collapseSearch);
            searchIconBtn.addEventListener('focus', expandSearch);
            searchInput.addEventListener('focus', expandSearch);
            searchInput.addEventListener('blur', collapseSearch);
            searchTab.addEventListener('focusin', expandSearch);
            searchTab.addEventListener('focusout', collapseSearch);
            searchIconBtn.addEventListener('click', expandSearch);
            
            // Search functionality
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                if (searchTerm.length > 0) {
                    const filteredRooms = allRooms.filter(room => {
                        const name = (room.name || '').toLowerCase();
                        const building = (room.building || '').toLowerCase();
                        return name.includes(searchTerm) || building.includes(searchTerm);
                    });
                    
                    // Clear active filter tabs
                    document.querySelectorAll('.filter-group .tab').forEach(tab => {
                        if (!tab.classList.contains('search-tab')) {
                            tab.classList.remove('active');
                        }
                    });
                    
                    // Render filtered rooms
                    renderSearchResults(filteredRooms);
                } else {
                    // Reset to default filter
                    document.querySelector('.filter-group .tab[data-filter="all"]').classList.add('active');
                    renderRooms('all');
                }
            });
        });

        function renderSearchResults(rooms) {
            const studyRooms = document.getElementById('study-rooms');
            studyRooms.innerHTML = '';
            
            // Apply favorites filter if active
            if (showOnlyFavorites) {
                rooms = rooms.filter(room => userFavorites.includes(room.id));
            }
            
            // Check if no rooms match the search
            if (rooms.length === 0) {
                studyRooms.innerHTML = `
                    <div class="no-results">
                        <i class="fas fa-search"></i>
                        <p>Nenhuma sala encontrada com os termos pesquisados.</p>
                    </div>
                `;
                return;
            }
            
            // Sort by ocupacao
            rooms.sort((a, b) => {
                const aOcc = (a.curOcc && a.maxOcc) ? a.curOcc / a.maxOcc : 0;
                const bOcc = (b.curOcc && b.maxOcc) ? b.curOcc / b.maxOcc : 0;
                if (ocupacaoOrder === 'maior') {
                    return bOcc - aOcc;
                } else {
                    return aOcc - bOcc;
                }
            });
            
            // Render rooms
            rooms.forEach((data) => {
                // Same rendering logic as in renderRooms function
                const name = data.name || 'Sala';
                const bloco = data.building || '';
                const curOcc = data.curOcc || 0;
                const maxOcc = data.maxOcc || 0;
                const ocupacao = (data.curOcc !== 0 && data.maxOcc !== 0)
                    ? Math.round((curOcc / maxOcc) * 100)
                    : null;
                let ocupacaoColor = '#22c55e';
                if (ocupacao >= 75) ocupacaoColor = '#ef4444';
                else if (ocupacao >= 50) ocupacaoColor = '#eab308';
                const temperatura = data.temperature !== undefined ? data.temperature : null;
                const ruido = data.noise_lvl !== undefined ? data.noise_lvl : null;
                let ruidoClass = '';
                let ruidoLabel = '';
                if (ruido >= 70) { ruidoClass = 'high'; ruidoLabel = 'Alto'; }
                else if (ruido >= 50) { ruidoClass = 'medium'; ruidoLabel = 'Médio'; }
                else if (ruido >= 30) { ruidoClass = 'low'; ruidoLabel = 'Baixo'; }
                else if (ruido < 30) { ruidoClass = 'very-low'; ruidoLabel = 'Muito Baixo'; }
                
                // Check if room is in favorites
                const isFavorite = userFavorites.includes(data.id);
                
                const card = document.createElement('div');
                card.className = 'room-card';
                card.innerHTML = `
                    <div class="room-header">
                        <div class="room-title">
                            <h3 class="room-name" style="color:var(--color-primary)">${name}</h3>
                            <button class="favorite-btn ${isFavorite ? 'active' : ''}" data-room-id="${data.id}">
                                <i class="${isFavorite ? 'fas' : 'far'} fa-star"></i>
                            </button>
                        </div>
                        <p>${bloco}</p>
                    </div>
                    <div class="room-indicators">
                        ${ocupacao !== null ? `
                        <div class="indicator">
                            <span class="indicator-label">Ocupação:</span>
                            <div class="progress-container">
                                <div class="progress-bar" style="width: ${ocupacao}%; background-color: ${ocupacaoColor};"></div>
                            </div>
                            <span class="indicator-value">${ocupacao}%</span>
                        </div>` : ''}
                        ${temperatura !== null ? `
                        <div class="indicator">
                            <span class="indicator-label">Temperatura:</span>
                            <span class="badge temperature-badge" style="background-color: ${getTemperatureColor(temperatura)}">
                                <i class="fas fa-thermometer-half"></i> ${temperatura}°C
                            </span>
                        </div>` : ''}
                        ${ruido !== null ? `
                        <div class="indicator">
                            <span class="indicator-label">Nível de Ruído:</span>
                            <span class="badge noise ${ruidoClass}">
                                <i class="fas ${getRuidoIcon(ruido)}"></i> ${ruidoLabel}
                            </span>
                        </div>` : ''}
                    </div>
                    <div class="room-actions">
                        <button class="button secondary detalhes-btn">
                            <i class="fas fa-info-circle"></i> Detalhes
                        </button>
                        <a href="ficheiros_html/mapa.html?sala=${encodeURIComponent(name)}&id=${data.id}" class="button primary">
                            <i class="fas fa-map-marker-alt"></i> Ver no Mapa
                        </a>
                    </div>
                `;
                
                // Add click event to Detalhes button for split view
                card.querySelector('.detalhes-btn').addEventListener('click', function(e) {
                    showSplitView(data);
                });
                
                // Add click event to favorite button
                card.querySelector('.favorite-btn').addEventListener('click', function(e) {
                    e.stopPropagation();
                    const roomId = this.getAttribute('data-room-id');
                    toggleFavorite(roomId);
                });
                
                studyRooms.appendChild(card);
            });
        }

        // Filter tabs functionality
        document.querySelectorAll('.filter-group .tab:not(.search-tab)').forEach(tab => {
            tab.addEventListener('click', function() {
                // Clear search input
                document.getElementById('search-input').value = '';
                
                // Remove active class from all tabs
                document.querySelectorAll('.filter-group .tab:not(.search-tab)').forEach(t => {
                    t.classList.remove('active');
                });
                
                // Add active class to clicked tab
                this.classList.add('active');
                
                // Render rooms with selected filter
                renderRooms(this.getAttribute('data-filter'));
            });
        });

        // Login modal functionality
        const loginModal = document.getElementById('loginModal');
        const loginBtn = document.getElementById('loginBtn');
        const closeBtn = document.querySelector('.close');
        
        loginBtn.addEventListener('click', function() {
            loginModal.style.display = 'block';
        });
        
        closeBtn.addEventListener('click', function() {
            loginModal.style.display = 'none';
        });
        
        window.addEventListener('click', function(event) {
            if (event.target === loginModal) {
                loginModal.style.display = 'none';
            }
        });
        
        // Modal tabs
        document.querySelectorAll('.modal-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                // Remove active class from all tabs
                document.querySelectorAll('.modal-tab').forEach(t => {
                    t.classList.remove('active');
                });
                
                // Add active class to clicked tab
                this.classList.add('active');
                
                // Hide all tab content
                document.querySelectorAll('.modal-body').forEach(content => {
                    content.style.display = 'none';
                });
                
                // Show selected tab content
                const tabId = this.getAttribute('data-tab');
                document.getElementById(`${tabId}Tab`).style.display = 'block';
            });
        });
        
        // Login form submission
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                await signInWithEmailAndPassword(auth, email, password);
                loginModal.style.display = 'none';
                showNotification('Login realizado com sucesso!', 'success');
            } catch (error) {
                console.error("Error signing in:", error);
                showNotification('Erro ao fazer login. Verifique suas credenciais.', 'error');
            }
        });
        
        // Register form submission
        document.getElementById('registerForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('registerConfirmPassword').value;
            
            if (password !== confirmPassword) {
                showNotification('As senhas não coincidem.', 'error');
                return;
            }
            
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                
                // Create user document
                await setDoc(doc(db, "users", userCredential.user.uid), {
                    email: email,
                    displayName: name,
                    favorites: []
                });
                
                loginModal.style.display = 'none';
                showNotification('Conta criada com sucesso!', 'success');
            } catch (error) {
                console.error("Error registering:", error);
                showNotification('Erro ao criar conta. Tente novamente.', 'error');
            }
        });
        
        // Google sign in
        document.querySelector('.google-btn').addEventListener('click', async function() {
            try {
                const result = await signInWithPopup(auth, provider);
                
                // Check if user document exists
                const userDocRef = doc(db, "users", result.user.uid);
                const userDoc = await getDoc(userDocRef);
                
                if (!userDoc.exists()) {
                    // Create user document if it doesn't exist
                    await setDoc(userDocRef, {
                        email: result.user.email,
                        displayName: result.user.displayName || '',
                        favorites: []
                    });
                }
                
                loginModal.style.display = 'none';
                showNotification('Login com Google realizado com sucesso!', 'success');
            } catch (error) {
                console.error("Error signing in with Google:", error);
                showNotification('Erro ao fazer login com Google.', 'error');
            }
        });
        
        // Logout
        document.getElementById('logoutBtn').addEventListener('click', async function() {
            try {
                await signOut(auth);
                showNotification('Logout realizado com sucesso!', 'success');
            } catch (error) {
                console.error("Error signing out:", error);
                showNotification('Erro ao fazer logout.', 'error');
            }
        });
        
        // Show notification
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div class="notification-content">
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
                    <span>${message}</span>
                </div>
                <button class="notification-close">&times;</button>
            `;
            
            document.body.appendChild(notification);
            
            // Show notification
            setTimeout(() => {
                notification.classList.add('show');
            }, 10);
            
            // Auto hide after 5 seconds
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 5000);
            
            // Close button
            notification.querySelector('.notification-close').addEventListener('click', function() {
                notification.classList.remove('show');
                setTimeout(() => {
                    notification.remove();
                }, 300);
            });
        }

        // Initialize
        getNames();

        // Banner logic
        function updateBanner(room) {
            const banner = document.getElementById('banner');
            banner.innerHTML = `
                <strong>${room.name || 'Sala'}</strong> - ${room.building || ''}
                <br>
                Ocupação: ... 
            `;
        }
    </script>
    <style>
    /* Split view styles */
    #split-view {
        display: flex;
        gap: 2rem;
        margin-top: 2rem;
        min-height: 420px;
    }
    .split-card {
        flex: 1 1 0;
        max-width: 350px;
        min-width: 0;
        display: flex;
        flex-direction: column;
        align-items: flex-start;
    }
    .split-map-container {
        flex: 2 1 0;
        min-width: 0;
        display: flex;
        align-items: stretch;
    }
    #split-map {
        width: 100%;
        height: 400px;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        background: #e5e7eb;
    }
    @media (max-width: 900px) {
        #split-view {
            flex-direction: column;
            gap: 1rem;
        }
        .split-card, .split-map-container {
            max-width: 100%;
            width: 100%;
        }
        #split-map {
            height: 300px;
        }
    }
    /* Hero section styles */
    .hero-flex {
        display: flex;
        align-items: flex-end;
        justify-content: space-between;
        gap: 2rem;
        flex-wrap: wrap;
    }
    .hero-title-search {
        flex: 1 1 300px;
        min-width: 250px;
    }
    .search-container {
        flex: 0 0 350px;
        max-width: 350px;
        min-width: 220px;
        margin-bottom: 0;
    }
    @media (max-width: 900px) {
        .hero-flex {
            flex-direction: column;
            align-items: stretch;
            gap: 1.5rem;
        }
        .search-container {
            max-width: 100%;
            width: 100%;
        }
    }
    /* Results section styles */
    .results-header-flex {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 2rem;
        flex-wrap: wrap;
        margin-bottom: 1.5rem;
    }
    .filter-tabs {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 2rem;
        padding-bottom: 0.5rem;
        position: relative;
        flex-wrap: wrap;
    }
    .filter-group {
        display: flex;
        gap: 0.5rem;
    }
    .filter-search {
        width: 44px;
        height: 44px;
        background: #fff;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        overflow: hidden;
        transition: width 0.3s cubic-bezier(.4,0,.2,1), box-shadow 0.2s;
        display: flex;
        align-items: center;
        border: 1px solid var(--color-border);
        cursor: pointer;
        position: relative;
        margin-left: 0.5rem;
        margin-right: 0.5rem;
    }
    .filter-search input {
        width: 0;
        border: none;
        outline: none;
        font-size: 1rem;
        padding: 0;
        background: transparent;
        transition: width 0.3s cubic-bezier(.4,0,.2,1), padding 0.3s;
        opacity: 0;
    }
    .filter-search button {
        background: none;
        border: none;
        color: var(--color-primary);
        font-size: 1.3rem;
        width: 44px;
        height: 44px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
        transition: background 0.2s;
    }
    .filter-search:hover,
    .filter-search:focus-within {
        width: 220px;
        box-shadow: var(--shadow-md);
    }
    .filter-search:hover input,
    .filter-search:focus-within input {
        width: 140px;
        padding: 0 0.75rem;
        opacity: 1;
        background: transparent;
    }
    .filter-search:hover button,
    .filter-search:focus-within button {
        background: var(--color-secondary);
        border-radius: 0 var(--border-radius) var(--border-radius) 0;
    }
    @media (max-width: 600px) {
        .filter-tabs {
            flex-direction: column;
            align-items: stretch;
            gap: 1rem;
        }
        .filter-search {
            width: 38px;
            height: 38px;
        }
        .filter-search:hover,
        .filter-search:focus-within {
            width: 100%;
        }
        .filter-search:hover input,
        .filter-search:focus-within input {
            width: 100%;
        }
    }
    .tab.search-tab {
        padding: 0;
        background-color: var(--color-secondary);
        border: 1px solid var(--color-border);
        border-radius: var(--border-radius);
        height: 2.5rem;
        min-width: 44px;
        display: flex;
        align-items: center;
        transition: box-shadow 0.2s;
        position: relative;
        overflow: hidden;
    }
    .tab.search-tab:focus-within,
    .tab.search-tab:hover {
        box-shadow: var(--shadow-md);
    }
    .tab.search-tab input[type="search"] {
        width: 0;
        opacity: 0;
        background: transparent;
        border: none;
        transition: width 0.3s, opacity 0.3s, padding 0.3s;
        font-size: 0.95em;
        color: var(--color-text);
    }
    .tab.search-tab:focus-within input[type="search"],
    .tab.search-tab:hover input[type="search"] {
        width: 140px;
        opacity: 1;
        padding: 0 0.75em;
        background: transparent;
    }
    .tab.search-tab button.search-button {
        background: none;
        border: none;
        color: #000;
        width: 2.2em;
        height: 2.2em;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 0 var(--border-radius) var(--border-radius) 0;
        transition: background 0.2s;
        padding: 0 0.2em;
    }
    .tab.search-tab:focus-within button.search-button,
    .tab.search-tab:hover button.search-button {
        background: var(--color-secondary);
    }
    .tab.search-tab:focus-within .search-label,
    .tab.search-tab:hover .search-label {
        display: inline-block;
    }
    @media (max-width: 600px) {
        .tab.search-tab input[type="search"] {
            width: 0;
        }
        .tab.search-tab:focus-within input[type="search"],
        .tab.search-tab:hover input[type="search"] {
            width: 100px;
        }
    }
    .search-icon-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 2.5rem;
        width: 2.5rem;
        padding: 0;
        margin: 0;
        background: none;
        border: none;
        cursor: pointer;
    }
    </style>
</body>
</html>
